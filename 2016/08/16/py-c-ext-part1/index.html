<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Python,C," />





  <link rel="alternate" href="/atom.xml" title="Wang Haowei - Python Programmer" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="å†™åšå®¢çš„åŠ¨æœºå½“äº†è¿™ä¹ˆä¹…çš„ç¨‹åºå‘˜ï¼Œä¸­é—´æœ‰å¥½å‡ æ¬¡ä¹Ÿæƒ³è¿‡å¼€ä¸ªåšå®¢å†™ç‚¹ä»€ä¹ˆã€‚å¯æ˜¯ä¸€æ¥è§‰å¾—è‡ªå·±å¤ªèœï¼Œå†åˆå®åœ¨è¿‡äºæ€ æƒ°ï¼Œè®¡åˆ’å°±æç½®ä¸€æ—(ä¹°äº†ä¸ªåŸŸåèººäº†ä¸€å¹´ğŸ˜‚)ã€‚ ç„¶è€Œä¸€ç›´ä»¥æ¥çœ‹äº†å„è·¯å¤§ä¾ çš„åšå®¢ï¼Œå·å·å­¦åˆ°ä¸å°‘ä¸œè¥¿, æ„Ÿè§‰å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆèœäº†ï¼Œä¹Ÿè§‰ç€åº”è¯¥æŠŠè‡ªå·±çš„ä¸€äº›æƒ³æ³•å’Œè§è§£åˆ†äº«å‡ºå»ï¼Œå›é¦ˆç¤¾ä¼š, è€Œä¸æ˜¯åœ¨è‡ªå·±çš„è„‘å­é‡Œé¢æ†‹ç€ï¼Œ å³ä½¿è¢«æ‰“è„¸ä¹Ÿç®—æ˜¯åˆå­¦åˆ°äº†å˜›, ä½•ä¹è€Œä¸ä¸ºã€‚
åœ¨ä¸‹ä¸€ä»‹Pythonç¨‹åºå‘˜, è€Œä¸”æ˜¯çœŸã®Pyt">
<meta property="og:type" content="article">
<meta property="og:title" content="An Introduction to Python C Extension Programming (Part1)">
<meta property="og:url" content="imiliya.com/2016/08/16/py-c-ext-part1/index.html">
<meta property="og:site_name" content="Wang Haowei - Python Programmer">
<meta property="og:description" content="å†™åšå®¢çš„åŠ¨æœºå½“äº†è¿™ä¹ˆä¹…çš„ç¨‹åºå‘˜ï¼Œä¸­é—´æœ‰å¥½å‡ æ¬¡ä¹Ÿæƒ³è¿‡å¼€ä¸ªåšå®¢å†™ç‚¹ä»€ä¹ˆã€‚å¯æ˜¯ä¸€æ¥è§‰å¾—è‡ªå·±å¤ªèœï¼Œå†åˆå®åœ¨è¿‡äºæ€ æƒ°ï¼Œè®¡åˆ’å°±æç½®ä¸€æ—(ä¹°äº†ä¸ªåŸŸåèººäº†ä¸€å¹´ğŸ˜‚)ã€‚ ç„¶è€Œä¸€ç›´ä»¥æ¥çœ‹äº†å„è·¯å¤§ä¾ çš„åšå®¢ï¼Œå·å·å­¦åˆ°ä¸å°‘ä¸œè¥¿, æ„Ÿè§‰å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆèœäº†ï¼Œä¹Ÿè§‰ç€åº”è¯¥æŠŠè‡ªå·±çš„ä¸€äº›æƒ³æ³•å’Œè§è§£åˆ†äº«å‡ºå»ï¼Œå›é¦ˆç¤¾ä¼š, è€Œä¸æ˜¯åœ¨è‡ªå·±çš„è„‘å­é‡Œé¢æ†‹ç€ï¼Œ å³ä½¿è¢«æ‰“è„¸ä¹Ÿç®—æ˜¯åˆå­¦åˆ°äº†å˜›, ä½•ä¹è€Œä¸ä¸ºã€‚
åœ¨ä¸‹ä¸€ä»‹Pythonç¨‹åºå‘˜, è€Œä¸”æ˜¯çœŸã®Pyt">
<meta property="og:updated_time" content="2016-08-18T18:05:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="An Introduction to Python C Extension Programming (Part1)">
<meta name="twitter:description" content="å†™åšå®¢çš„åŠ¨æœºå½“äº†è¿™ä¹ˆä¹…çš„ç¨‹åºå‘˜ï¼Œä¸­é—´æœ‰å¥½å‡ æ¬¡ä¹Ÿæƒ³è¿‡å¼€ä¸ªåšå®¢å†™ç‚¹ä»€ä¹ˆã€‚å¯æ˜¯ä¸€æ¥è§‰å¾—è‡ªå·±å¤ªèœï¼Œå†åˆå®åœ¨è¿‡äºæ€ æƒ°ï¼Œè®¡åˆ’å°±æç½®ä¸€æ—(ä¹°äº†ä¸ªåŸŸåèººäº†ä¸€å¹´ğŸ˜‚)ã€‚ ç„¶è€Œä¸€ç›´ä»¥æ¥çœ‹äº†å„è·¯å¤§ä¾ çš„åšå®¢ï¼Œå·å·å­¦åˆ°ä¸å°‘ä¸œè¥¿, æ„Ÿè§‰å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆèœäº†ï¼Œä¹Ÿè§‰ç€åº”è¯¥æŠŠè‡ªå·±çš„ä¸€äº›æƒ³æ³•å’Œè§è§£åˆ†äº«å‡ºå»ï¼Œå›é¦ˆç¤¾ä¼š, è€Œä¸æ˜¯åœ¨è‡ªå·±çš„è„‘å­é‡Œé¢æ†‹ç€ï¼Œ å³ä½¿è¢«æ‰“è„¸ä¹Ÿç®—æ˜¯åˆå­¦åˆ°äº†å˜›, ä½•ä¹è€Œä¸ä¸ºã€‚
åœ¨ä¸‹ä¸€ä»‹Pythonç¨‹åºå‘˜, è€Œä¸”æ˜¯çœŸã®Pyt">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'åšä¸»'
    }
  };
</script>




  <link rel="canonical" href="imiliya.com/2016/08/16/py-c-ext-part1/"/>

  <title> An Introduction to Python C Extension Programming (Part1) | Wang Haowei - Python Programmer </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Wang Haowei - Python Programmer</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Python! Pythoner! Pythonest!</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                An Introduction to Python C Extension Programming (Part1)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2016-08-16T08:45:36+08:00" content="2016-08-16">
              2016-08-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming/" itemprop="url" rel="index">
                    <span itemprop="name">Programming</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/16/py-c-ext-part1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/16/py-c-ext-part1/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="å†™åšå®¢çš„åŠ¨æœº"><a href="#å†™åšå®¢çš„åŠ¨æœº" class="headerlink" title="å†™åšå®¢çš„åŠ¨æœº"></a>å†™åšå®¢çš„åŠ¨æœº</h2><p>å½“äº†è¿™ä¹ˆä¹…çš„ç¨‹åºå‘˜ï¼Œä¸­é—´æœ‰å¥½å‡ æ¬¡ä¹Ÿæƒ³è¿‡å¼€ä¸ªåšå®¢å†™ç‚¹ä»€ä¹ˆã€‚å¯æ˜¯ä¸€æ¥è§‰å¾—è‡ªå·±å¤ªèœï¼Œå†åˆå®åœ¨è¿‡äºæ€ æƒ°ï¼Œè®¡åˆ’å°±æç½®ä¸€æ—(ä¹°äº†ä¸ªåŸŸåèººäº†ä¸€å¹´ğŸ˜‚)ã€‚ ç„¶è€Œä¸€ç›´ä»¥æ¥çœ‹äº†å„è·¯å¤§ä¾ çš„åšå®¢ï¼Œå·å·å­¦åˆ°ä¸å°‘ä¸œè¥¿, æ„Ÿè§‰å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆèœäº†ï¼Œä¹Ÿè§‰ç€åº”è¯¥æŠŠè‡ªå·±çš„ä¸€äº›æƒ³æ³•å’Œè§è§£åˆ†äº«å‡ºå»ï¼Œå›é¦ˆç¤¾ä¼š, è€Œä¸æ˜¯åœ¨è‡ªå·±çš„è„‘å­é‡Œé¢æ†‹ç€ï¼Œ å³ä½¿è¢«æ‰“è„¸ä¹Ÿç®—æ˜¯åˆå­¦åˆ°äº†å˜›, ä½•ä¹è€Œä¸ä¸ºã€‚</p>
<p>åœ¨ä¸‹ä¸€ä»‹Pythonç¨‹åºå‘˜, è€Œä¸”æ˜¯<em>çœŸã®Pythonç²‰</em>ï¼Œé‚£å°±ä»Pythonå†™èµ·å§, ä¹Ÿæ¯”è¾ƒå¾—å¿ƒåº”æ‰‹ä¸€ç‚¹ã€‚ç°ä»Šå¸‚é¢ä¸Šå……æ–¥å„ç§Pythonæ•™ç¨‹(Pythonä¹ŸçœŸæ˜¯å¤ªç®€å•æ˜“ä¸Šæ‰‹äº†), æˆ‘å°±ä¸å»å‡‘è¿™ä¸ªçƒ­é—¹ä¹Ÿè®²äº›PythonåŸºç¡€æˆ–è€…<em>tips</em>ä»€ä¹ˆçš„äº†ã€‚å°†è¦è®²åˆ°çš„å†…å®¹éƒ½æ˜¯é¢å‘è‡³å°‘ä¸­çº§çš„Pythonç¨‹åºå‘˜çš„. æ‰€ä»¥è¯»è€…æœ€å¥½æ˜¯å…·å¤‡ä¸€å®šçš„Pythonæ°´å¹³ï¼Œå¦‚æœæ˜¯åˆšå…¥é—¨çš„å°æœ‹å‹, è‡³å°‘å…ˆä¹°ä¸¤æœ¬å…¥é—¨æ•™ç¨‹æ’¸ä¸€éå†æ¥å§ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ä¸é€ã€‚</p>
<p>æš‚å®šçš„ç³»åˆ—æœ‰</p>
<ol>
<li>Python C Extension</li>
<li>Profile</li>
<li>Debugging</li>
<li>Python2 or Python3</li>
<li>Unicode</li>
<li>AsyncIO</li>
<li>Modules</li>
<li>Logging</li>
</ol>
<a id="more"></a>
<h2 id="First-of-first-Python-C-Extension"><a href="#First-of-first-Python-C-Extension" class="headerlink" title="First of first (Python C Extension)"></a>First of first (Python C Extension)</h2><p>ä¸çŸ¥é“å¤§å®¶è§‰å¾—Pythonæœ€ç¥ç§˜çš„åœ°æ–¹åœ¨å“ªé‡Œã€‚åæ­£åœ¨æˆ‘çš„ç»éªŒçœ‹æ¥ï¼Œæœ€æä¸æ¸…æ‰¯ä¸æ˜çš„åœ°æ–¹å°±æ˜¯æ‰€è°“çš„Python C Extension Moduleäº†ã€‚ctypesï¼Œ cffiï¼Œ swigï¼Œ cython, numbaè¿™äº›åè¯ï¼Œå¬ä¸Šå»å°±è§‰å¾—å¥½å¯æ€•, æƒ³æœä¸ªåƒæ ·å­çš„ä»‹ç»æ–‡ç« å‡ºæ¥éƒ½éš¾, ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£å§æœ‰æ„Ÿè§‰æœ‰ç‚¹overwhelming. æ‰€ä»¥æˆ‘å¸Œæœ›é€šè¿‡C Extensionè¿™ä¸ªç³»åˆ—çš„æ–‡ç« ï¼ŒæŠŠè¿™äº›ç©æ„å„¿ä¸€ä¸ªä¸€ä¸ªéƒ½æ¢ç´¢ä¸€ä¸‹ã€‚ æœ¬äººCè¯­è¨€æ°´å¹³æœ‰é™ï¼Œå¦‚æœæœ‰èƒ¡è¯´å…«é“çš„åœ°æ–¹ï¼Œ æ¬¢è¿æŒ‡æ­£ï¼Œå¤§å®¶ä¸€èµ·å­¦ä¹ è¿›æ­¥ğŸ˜€ã€‚ ä»¥åæ‰€æœ‰æ–‡ç« åªé’ˆå¯¹Python3ï¼Œå…³äº<em>Python2 or Python3</em>, ä»¥åä¹Ÿä¼šæ‰¾æœºä¼šè®¨è®ºä¸€ä¸‹, å¦‚æœæœ‰å¿…è¦è”ç³»Python2çš„ç›¸å…³çŸ¥è¯†æˆ‘ä¼šä¸“é—¨æŒ‡å‡º, æ–‡ä¸­æ‰€æœ‰æ¶‰åŠåˆ°ç¼–è¯‘cä»£ç çš„åœ°æ–¹éƒ½å‡è®¾è¯»è€…ä½¿ç”¨çš„æ˜¯ç±»unixçš„æ“ä½œç³»ç»Ÿ(åŸå› æ˜¯æˆ‘å¯¹windowsçš„ç”Ÿæ€ç³»ç»Ÿå®åœ¨ä¸€æ— æ‰€çŸ¥)ã€‚</p>
<h2 id="why-C"><a href="#why-C" class="headerlink" title="why C?"></a>why C?</h2><p>å¥½å§ï¼Œæˆ‘ä»¬ç”¨Pythonæ˜¯å› ä¸ºå®ƒå¾ˆé«˜çš„æŠ½è±¡å±‚æ¬¡ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿…é€Ÿçš„æ„å»ºåº”ç”¨ï¼Œä¸è®ºæ˜¯å†™ä¸€ä¸ªç®€å•çš„ä»»åŠ¡è„šæœ¬è¿˜æ˜¯æ­ä¸€ä¸ªå°å‹ç½‘ç«™ï¼ŒPythonéƒ½æ˜¯ä¸Šä½³é€‰æ‹©ã€‚ç„¶è€Œä¸–ä¸Šæ²¡æœ‰å…è´¹åˆé¤ï¼Œå¼€å‘æ•ˆç‡çš„ä»£ä»·æ˜¯ç‰ºç‰²äº†è½¯ä»¶æ€§èƒ½ï¼Œä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹è¿™éƒ½ä¸æ˜¯äº‹ï¼Œæ¯”å¦‚Pythonæ„å»ºçš„web appæ€§èƒ½ç“¶é¢ˆå¤§å¤šéƒ½åœ¨IOï¼Œè¿™æ˜¯æ²¡æ³•åœ¨ä»£ç å±‚é¢ä¼˜åŒ–çš„, å¯ä»¥é€šè¿‡æ”¹å˜IOæ¨¡å‹æˆ–è€…æ‰©å®¹æœåŠ¡å™¨æ¥è§£å†³ã€‚è€Œä¸”ä¸€èˆ¬çš„Pythonç¨‹åºå‘˜ä¹ æƒ¯äº†Pythonçš„ç®€ä»‹ä¼˜é›…ï¼Œå¯èƒ½å¯¹æ€§èƒ½ä»€ä¹ˆçš„æ²¡ä»€ä¹ˆæ¦‚å¿µã€‚ä¸è¿‡å¤œè·¯èµ°å¤šäº†æ€»ä¼šæ’é¬¼ï¼Œå¹³å¸¸æ²¡æœ‰æ„è¯†ï¼ŒçœŸæ­£æ€§èƒ½å‡ºç°é—®é¢˜éœ€è¦ä¼˜åŒ–çš„æ—¶å€™åªèƒ½æ˜¯ä¸€è„¸æ‡µé€¼ã€‚å¦‚æœèƒ½å¤Ÿå…·å¤‡ä¸€å®šçš„æ€§èƒ½æ„è¯†ï¼Œåœ¨éœ€è¦çš„æ—¶å€™çŸ¥é“æœ‰å“ªäº›åŠæ³•å¯ä»¥é€‰æ‹©å’Œå°è¯•ï¼Œé‚£ä¹ˆè‡³å°‘æ˜¯èµ°åœ¨äº†æ­£ç¡®çš„é“è·¯ä¸Šã€‚æ€§èƒ½Profileä¹Ÿæ˜¯ä¸€ä¸ªå¤§çš„è¯é¢˜ï¼Œä»¥åå†å±•å¼€ã€‚</p>
<p>å­¦ä¹ C Extension Programmingä¹Ÿèƒ½åŠ æ·±å¯¹Pythonè¯­è¨€æœ¬èº«çš„ç†è§£ï¼Œ å¯¹äºå†™å‡ºæ›´é«˜è´¨é‡çš„Pythonä»£ç ä¹Ÿæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚ æ‰€ä»¥åºŸè¯ä¸å¤šè¯´ï¼Œè¿›å…¥ç¬¬ä¸€ä¸ªè¯é¢˜ï¼Œå¦‚ä½•åœ¨Pythonä»£ç é‡Œé¢è°ƒç”¨Cå‡½æ•°.</p>
<h2 id="How-to-call-C-function-in-Python-code"><a href="#How-to-call-C-function-in-Python-code" class="headerlink" title="How to call C function in Python code?"></a>How to call C function in Python code?</h2><p>pythonæ ‡å‡†åº“æä¾›äº†<a href="https://docs.python.org/3.5/library/ctypes.html#module-ctypes" target="_blank" rel="external"><strong>ctypes</strong></a>æ¨¡å—, å¯ä»¥å¸®åŠ©æˆ‘ä»¬æŠŠDLLæˆ–è€…shared libraries(å…±äº«åº“)ä¸­çš„å‡½æ•°å°è£…æˆå¯ä»¥ç›´æ¥è°ƒç”¨çš„Pythonå‡½æ•°ã€‚å¦‚æœå‘ç°éœ€è¦çš„æŸä¸ªå·¥å…·å·²ç»æœ‰Cè¯­è¨€çš„library, æˆ‘ä»¬å°±ä¸éœ€è¦é‡æ–°ç”¨Pythonå®ç°ç›¸åŒåŠŸèƒ½çš„æ¨¡å—ï¼Œ æ—¢ä¿è¯äº†æ•ˆç‡è¿˜èƒ½çœå»æ€§èƒ½çš„çƒ¦æ¼ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­:</p>
<p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªCæ–‡ä»¶<code>utils.c</code>, å®šä¹‰factorialå’Œswapä¸¤ä¸ªå‡½æ•°.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">factorial</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (x &lt;= <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> factorial(x<span class="number">-1</span>) * x;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> *a, <span class="keyword">int</span> *b)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> temp = *a;</div><div class="line">  *a = *b;</div><div class="line">  *b = temp;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶<code>utils.o</code>(æˆ‘ç”¨çš„æ˜¯Macä¸‹é¢çš„LLVMç¼–è¯‘å™¨ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -c -Wall -Werror utils.c</div></pre></td></tr></table></figure>
<p>å†æŠŠåˆšç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶è½¬åŒ–æˆåŠ¨æ€é“¾æ¥åº“.</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">gcc</span> <span class="selector-tag">-shared</span> <span class="selector-tag">-o</span> <span class="selector-tag">libutils</span><span class="selector-class">.so</span> <span class="selector-tag">utils</span><span class="selector-class">.o</span></div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨<em>Python</em>ä»£ç ä¸­è°ƒç”¨åˆšæ‰åœ¨<code>utils.c</code>ä¸­å®šä¹‰çš„ä¸¤ä¸ªå‡½æ•°. ä¸‹é¢ç¤ºä¾‹å¦‚ä½•ç”¨<em>ctypes</em>æ¥æ“ä½œï¼Œåˆ›å»ºæ–‡ä»¶<code>main.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ctypes</div><div class="line"></div><div class="line"></div><div class="line">utils = ctypes.cdll.LoadLibrary(<span class="string">'./libutils.so'</span>)</div><div class="line"></div><div class="line">factorial = utils.factorial</div><div class="line">factorial.argtypes = (ctypes.c_int,)</div><div class="line">factorial.restype = ctypes.c_int</div><div class="line"></div><div class="line">_swap  = utils.swap</div><div class="line">_swap.argtypes = (ctypes.POINTER(ctypes.c_int), ctypes.POINTER(ctypes.c_int))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">swap</span><span class="params">(x, y)</span>:</span></div><div class="line">    a = ctypes.c_int(x)</div><div class="line">    b = ctypes.c_int(y)</div><div class="line">    _swap(a, b)</div><div class="line">    <span class="keyword">return</span> a.value, b.value</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    print(<span class="string">'factorial of 4 is %s !'</span> % factorial(<span class="number">4</span>))</div><div class="line">    print(<span class="string">'factorial of 5 is %s !'</span> % factorial(<span class="number">5</span>))</div><div class="line"></div><div class="line">    x, y = <span class="number">10</span>, <span class="number">20</span></div><div class="line">    print(<span class="string">'x is %s and y is %s'</span> % (x, y))</div><div class="line">    x, y = swap(x, y)</div><div class="line">    print(<span class="string">'after swap'</span>)</div><div class="line">    print(<span class="string">'x is %s and y is %s'</span> % (x, y))</div></pre></td></tr></table></figure>
<p><code>utils = ctypes.cdll.LoadLibrary(&#39;./libutils.so&#39;)</code> è½½å…¥äº†å·²ç»ç¼–è¯‘å¥½çš„<code>libutils.so</code>, factorialå’Œswapä¸¤ä¸ªå‡½æ•°å˜æˆäº†æ¨¡å—çš„locals.ï¼ˆå¦‚æœä¸æ˜¯è‡ªå·±ç¼–è¯‘çš„æ¨¡å—è€Œæ˜¯æƒ³ç”¨ç³»ç»Ÿçš„Cè¯­è¨€å…±äº«åº“ï¼Œå‚è€ƒ<code>cypes.utils</code>çš„<code>find_library</code>æ–¹æ³•ï¼Œè·¯å¾„é€šå¸¸éƒ½æ˜¯<code>/usr/lib</code> å’Œ <code>/usr/local/lib</code>ï¼Œ linuxæ“ä½œç³»ç»Ÿé»˜è®¤éƒ½æ˜¯<em>libxxx.so</em>çš„æ ¼å¼ï¼Œ è€Œos xåˆ™æ˜¯<em>libxxx.dylib</em>)</p>
<p>å¯¹äº<code>factorial</code>å‡½æ•°ï¼Œåªéœ€è¦æŠŠpythonçš„intå¯¹è±¡è½¬æ¢æˆå¯¹åº”çš„ctypeç±»å‹å†ä¼ å…¥factorialå‡½æ•°ï¼Œ åŒæ—¶éœ€è¦å®šä¹‰è¿”å›çš„ç»“æœç±»å‹ï¼ŒæŠŠfactorialå‡½æ•°è¿”å›çš„intè½¬æ¢æˆPythonçš„intå¯¹è±¡</p>
<p><code>swap</code>å‡½æ•°ç¨å¾®éº»çƒ¦ä¸€ç‚¹ï¼Œå› ä¸ºPythonä¸èƒ½ç›´æ¥è®¿é—®æŒ‡é’ˆï¼Œæ‰€ä»¥éœ€è¦æŠŠå·²æœ‰çš„cå‡½æ•°ç¨å¾®åšä¸ªå°è£…ï¼Œ ä¸è¿‡æ€è·¯ä¸€æ ·å°±æ˜¯äº†.</p>
<p>æœ€åéªŒè¯ä¸€ä¸‹ç»“æœã€‚<br>è¿è¡Œ</p>
<pre><code>python3 main.py
</code></pre><p>ç»ˆç«¯è¾“å‡º</p>
<pre><code>factorial of 4 is 24 !
factorial of 5 is 120 !
x is 10 and y is 20
after swap
x is 20 and y is 10
</code></pre><p>Perfect! ç®€å•çš„å‡ ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†åœ¨Pythonä¸­è°ƒç”¨cå‡½æ•°.</p>
<p>é¡ºä¾¿æˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹Cè¯­è¨€å®ç°çš„factorialå’ŒPythonç‰ˆæœ¬çš„æ€§èƒ½,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ctypes</div><div class="line"><span class="keyword">from</span> timeit <span class="keyword">import</span> timeit</div><div class="line"></div><div class="line"></div><div class="line">utils = ctypes.cdll.LoadLibrary(<span class="string">'./libutils.so'</span>)</div><div class="line"></div><div class="line">factorial = utils.factorial</div><div class="line">factorial.argtypes = (ctypes.c_int,)</div><div class="line">factorial.restype = ctypes.c_int</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">py_factorial</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">assert</span> isinstance(n, int)</div><div class="line">    <span class="keyword">if</span> n &lt;= <span class="number">0</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">return</span> py_factorial(n<span class="number">-1</span>) * n</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    number = <span class="number">100000</span></div><div class="line">    print(<span class="string">'Python ç‰ˆæœ¬100000æ¬¡çš„factorial(10)æ—¶é—´'</span>)</div><div class="line">    print(timeit(<span class="string">'py_factorial(10)'</span>, number=number, globals=globals()))</div><div class="line">    print(<span class="string">'C ç‰ˆæœ¬100000æ¬¡çš„factorial(10)æ—¶é—´'</span>)</div><div class="line">    print(timeit(<span class="string">'factorial(10)'</span>, number=number, globals=globals()))</div></pre></td></tr></table></figure>
<p>ä¿å­˜åˆ°<code>benchmark.py</code></p>
<p>åœ¨æˆ‘çš„æœºå™¨ä¸Šè¿è¡Œçš„ç»“æœæ˜¯</p>
<pre><code>Python ç‰ˆæœ¬100000æ¬¡çš„factorial(10)æ—¶é—´
0.3275668309943285
C ç‰ˆæœ¬100000æ¬¡çš„factorial(10)æ—¶é—´
0.07990392099600285
</code></pre><p>å¤§æ¦‚4å€çš„æ ·å­, very nice!</p>
<p>ç¬¬ä¸€ä¸ªä¾‹å­å°±åˆ°è¿™é‡Œäº†ï¼Œctypesæ‰“å¼€äº†Pythonè°ƒç”¨cä»£ç åº“çš„å¤§é—¨ã€‚ ç„¶è€Œå¾ˆå¤šæ—¶å€™å¹¶æ²¡æœ‰ç°æˆçš„cåº“ç»™æˆ‘ä»¬è°ƒï¼Œ é‚£ä¹ˆå°±éœ€è¦è‡ªå·±å†™Pythonçš„C Extensionäº†ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬å…ˆç ”ç©¶ä¸€ä¸‹å¦‚ä½•è£¸å†™ä¸€ä¸ªPythonçš„C extensionæ¨¡å—å§.</p>
<p>ä¸Šé¢ç¤ºä¾‹çš„ä»£ç å·²ç»æ”¾åˆ°<a href="https://github.com/moonshadow/way-to-python-ninja" target="_blank" rel="external"><strong>github</strong></a>ä¸Šé¢äº†ï¼Œå¯ä»¥æ‹‰ä¸‹æ¥å‚ç…§<a href="https://docs.python.org/3.5/library/ctypes.html#module-ctypes" target="_blank" rel="external"><strong>ctypes</strong></a>çš„æ–‡æ¡£è‡ªå·±ç©ç©, å¦‚æœä½ æœ‰æ›´å¥½çš„sampleæˆ–è€…å»ºè®®æ¬¢è¿ä¸€èµ·äº¤æµ.</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Python/" rel="tag">#Python</a>
          
            <a href="/tags/C/" rel="tag">#C</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/08/19/py-c-ext-part2/" rel="prev" title="An Introduction to Python C Extension Programming (Part2)">
                An Introduction to Python C Extension Programming (Part2) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Moonshadow" />
          <p class="site-author-name" itemprop="name">Moonshadow</p>
          <p class="site-description motion-element" itemprop="description">Write about Python, Linux, ACG and other interesting stuffs.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">2</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/moonshadow" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/moonshadow520" target="_blank" title="twitter">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å†™åšå®¢çš„åŠ¨æœº"><span class="nav-number">1.</span> <span class="nav-text">å†™åšå®¢çš„åŠ¨æœº</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#First-of-first-Python-C-Extension"><span class="nav-number">2.</span> <span class="nav-text">First of first (Python C Extension)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#why-C"><span class="nav-number">3.</span> <span class="nav-text">why C?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-call-C-function-in-Python-code"><span class="nav-number">4.</span> <span class="nav-text">How to call C function in Python code?</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Moonshadow</span>
</div>

<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'imiliya';
      var disqus_identifier = '2016/08/16/py-c-ext-part1/';
      var disqus_title = "An Introduction to Python C Extension Programming (Part1)";
      var disqus_url = 'http://imiliya.com/2016/08/16/py-c-ext-part1/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  




  
  

  

  

  

</body>
</html>
