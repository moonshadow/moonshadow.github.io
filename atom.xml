<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Wang Haowei - â„™Æ´â˜‚â„ŒÃ¸á¼¤ Programmer</title>
  <subtitle>Python! Pythoner! Pythonest!</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://imiliya.com/"/>
  <updated>2016-09-03T06:57:17.000Z</updated>
  <id>http://imiliya.com/</id>
  
  <author>
    <name>Moonshadow</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Beauty of Morden JavaScript</title>
    <link href="http://imiliya.com/2016/09/03/Beauty-of-Morden-JavaScript/"/>
    <id>http://imiliya.com/2016/09/03/Beauty-of-Morden-JavaScript/</id>
    <published>2016-09-02T21:15:31.000Z</published>
    <updated>2016-09-03T06:57:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä»€ä¹ˆï¼Ÿä½ ä¸æ˜¯Pythonç¨‹åºå‘˜ä¹ˆï¼Œæ€ä¹ˆè·‘è¿‡æ¥å¹JavaScriptäº†ï¼Ÿçªƒä»¥ä¸ºåªæœ‰å¹¼ç¨šçš„ç¨‹åºå‘˜æ‰ä¼šåæ‰§äºä¸€ä¸¤é—¨è¯­è¨€ï¼Œæ•…æ­¥è‡ªå°ï¼Œä¼˜ç§€çš„ç¨‹åºå‘˜å°±ä¼šçŸ¥é“åšè§ˆä¼—é•¿ï¼Œçº³ä¸ºå·±ç”¨ã€‚ JavaScriptï¼Œ è¿™é—¨ç¥å¥‡çš„è¯­è¨€ï¼Œä»20å¹´å‰ä¸€ä¸ªç¤¼æ‹œå°±è®¾è®¡å®Œæˆçš„ç©å…·è¯­è¨€ï¼Œç»è¿‡å²æœˆçš„æ´—ç¤¼ï¼Œå¦‚ä»Šå·²ç»ç™»ä¸Šå¤§é›…ä¹‹å ‚ï¼Œä»æµè§ˆå™¨åˆ°æœåŠ¡å™¨ï¼Œç”šè‡³åˆ°åµŒå…¥å¼ç³»ç»Ÿï¼ŒJavaScriptæ— å¤„ä¸åœ¨ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºå‘˜ç°åœ¨è¿˜å¯¹JavaScriptä¸å±‘ä¸€é¡¾æˆ–è€…ä¸å»å­¦ä¹ ä¸€ä¸‹(ä¹Ÿè®¸æ”¾åˆ°ä¸¤ä¸‰å¹´å‰è¿™å¹¶ä¸æ˜¯ä»€ä¹ˆé—®é¢˜)ï¼Œæ„Ÿè§‰å¯ä»¥å›å»åçœä¸€ä¸‹ã€‚<br><a id="more"></a></p>
<p>æœ¬æ–‡çš„ä¸»é¢˜æ˜¯Beauty of Morden JavaScript, è¿™ä¸ªMorden JavascriptåŒ…æ‹¬ES6ç”šè‡³ES7, å³ä¾¿æ˜¯æ²¡æœ‰æ­£å¼æ•²å®šçº³å…¥standardï¼Œé‚£äº›å·²ç»è¢«å„ç§å¼€æºé¡¹ç›®å¤§é‡ä½¿ç”¨çš„ç‰¹æ€§å½“ç„¶åŒ…å«åœ¨å…¶ä¸­ã€‚å› ä¸ºæœ€è¿‘æå‰ç«¯é¡¹ç›®æ¯”è¾ƒå¤šï¼Œæ‰èƒ½æ…¢æ…¢å‘ç°ä¹‹å‰æ²¡æœ‰æ³¨æ„è¿‡çš„ä¸€äº›ç¾çš„åœ°æ–¹, æœ‰æ—¶å€™ä¹Ÿç«Ÿä¹Ÿä¼šäº§ç”Ÿå¦‚æœPythonä¹Ÿèƒ½è¿™æ ·å†™æœ‰å¤šå¥½çš„æƒ³æ³•ã€‚ä¸å¤šåºŸè¯ï¼Œä¸‹é¢å¼€å§‹æˆ‘ä»¬çš„æ¬£èµä¹‹æ—…ã€‚</p>
<h2 id="Modular-JavaScript"><a href="#Modular-JavaScript" class="headerlink" title="Modular JavaScript"></a>Modular JavaScript</h2><p>æ²¡æœ‰æ¨¡å—æœºåˆ¶çš„JSç®€ç›´å°±æ˜¯ä¸ªç¬‘è¯ï¼Œå±…ç„¶è¦é€šè¿‡closureæ¥åˆ›é€ namespaceï¼ŒçœŸæ˜¯åäººç±»ã€‚ä¸è¿‡ç°åœ¨ä¸€åˆ‡éƒ½ç»“æŸäº†ï¼ŒES6å¼•å…¥äº†<code>import</code>ï¼Œç»ˆäºä¸ç”¨careè›‹ç–¼çš„globalsäº†ã€‚</p>
<p>math.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> add = (a, b) =&gt; a + b;</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> name = <span class="string">'Math'</span>;</div><div class="line"><span class="keyword">const</span> negative = (a) =&gt; -a;</div></pre></td></tr></table></figure></p>
<p><code>math.js</code>è¾“å‡ºäº†<code>add</code>å’Œ<code>name</code>å‡½æ•°ï¼Œ<code>negative</code>ä½œä¸ºæ¨¡å—çš„ç§æœ‰å‡½æ•°ï¼Œä¸èƒ½è¢«å…¶ä»–æ¨¡å—è®¿é—®.<br>default export è®©å¼€å‘è€…é€‰ä¸€ä¸ªè‡ªå·±è§‰å¾—ä¸€ä¸ªæœ€é‡è¦çš„apiè¾“å‡ºï¼Œ<br>è€Œå…¶ä»–æƒ³è¦è¾“å‡ºçš„apiï¼Œåªéœ€è¦åœ¨å‰é¢åŠ ä¸€ä¸ªexportå°±OKã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> math <span class="string">'math'</span>; <span class="comment">// or import &#123; add &#125; from 'math';</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> name <span class="keyword">from</span> <span class="string">'math'</span>; <span class="comment">// name å¯ä»¥éšä¾¿æ”¹å</span></div></pre></td></tr></table></figure>
<p>ä¸€ä¸ªæ¨¡å—çš„å¯¹å¤–çš„ä»·å€¼å°±åœ¨äºä»–æä¾›çš„APIï¼Œ åœ¨Pythoné‡Œé¢ï¼Œåªè¦æ˜¯æ¨¡å—ä¸­çš„å˜é‡(æŸäº›ç‰¹æ®Šæƒ…å†µé™¤å¤–)ï¼Œéƒ½å¯ä»¥è¢«å…¶ä»–æ¨¡å—ç›´æ¥importï¼Œ<br>å¾ˆå®¹æ˜“é€ æˆä¸€ä¸ªæ¨¡å—å†™äº†ä¸€å¤§å¨å‡½æ•°ï¼Œç„¶åç¨€é‡Œç³Šæ¶‚çš„å°±å…¨éƒ¨<code>export</code>å‡ºå»äº†ï¼Œå®Œå…¨æä¸æ¸…æ¥šè¿™ä¸ªæ¨¡å—åˆ°åº•åœ¨å¹²å˜›ã€‚é€šè¿‡æ˜¾ç¤ºçš„å£°æ˜exportçš„å˜é‡ï¼Œ<br>ç¨‹åºå‘˜è®¾è®¡çš„æ—¶å€™å°±ä¼šæ›´åŠ ä¸è‡ªä¸»çš„æ€è€ƒè¿™ä¸ªæ¨¡å—çš„è¾¹ç•Œ(boundary), æ›´èƒ½æœ‰æ„è¯†çš„è®¾è®¡èŒè´£æ›´åŠ æ˜ç¡®çš„æ¨¡å—ã€‚</p>
<p>æœ‰äº†<code>import</code>æœºåˆ¶, IIFE, angularçš„ä¾èµ–æ³¨å…¥è¿™äº›è€æŠŠæˆï¼Œéƒ½å¯ä»¥é€€å‡ºå†å²èˆå°äº†ï¼Œsayonaraï¼</p>
<h2 id="Simple-Javascript"><a href="#Simple-Javascript" class="headerlink" title="Simple Javascript"></a>Simple Javascript</h2><p>destructing<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> obj = &#123; a: <span class="number">12</span>, b: <span class="number">13</span>, c: <span class="number">14</span> &#125;;</div><div class="line"><span class="keyword">const</span> &#123; a, b, c &#125;  = obj;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥ç›´æ¥å°†ä¸€ä¸ªå¯¹è±¡è§£æ„</p>
<p>æˆ‘æƒ³åœ¨Pythoné‡Œé¢åšåŒæ ·çš„äº‹æƒ…<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">obj = &#123; &apos;a&apos;: 12, &apos;b&apos;: 13, &apos;c&apos;: 14 &#125;;</div><div class="line">a, b, c = obj;</div></pre></td></tr></table></figure></p>
<p>ç»“æœå´æ˜¯ a = â€˜aâ€™, b = â€˜bâ€™, c = â€˜câ€™ã€‚</p>
<p>å› ä¸ºJSç”¨çš„æ˜¯pattern matchï¼Œè€Œpythonåˆ™æ˜¯ç”¨çš„è¿­ä»£å™¨unpackï¼Œæ‰€ä»¥<code>a, b, c = iter(obj)</code>, ehmmï¼ŒAt this point, JS is better ï¼</p>
<p>object spread</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> obj = &#123; a: <span class="number">12</span>, b: <span class="number">13</span>, c: <span class="number">14</span> &#125;;</div><div class="line"><span class="keyword">const</span> newObj = &#123; ...obj, a: <span class="number">16</span>, d: <span class="number">18</span> &#125;;</div></pre></td></tr></table></figure>
<p>å¯¹è±¡å±•å¼€çš„è¯­æ³•çœŸæ˜¯ç»™äººå±Œç‚¸å¤©çš„æ„Ÿè§‰ã€‚ç›´æ¥åŸºäºå·²æœ‰å¯¹è±¡çš„å±æ€§ç”Ÿæˆæ–°çš„å¯¹è±¡ã€‚How could I achieve this in Python?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">obj = &#123; &apos;a&apos;: 12, &apos;b&apos;: 13, &apos;c&apos;: 14 &#125;;</div><div class="line">new_obj = &#123; k: v for k, v in obj.items() &#125;</div><div class="line">new_obj[&apos;a&apos;] = 16</div><div class="line">new_obj[&apos;d&apos;] = 18</div></pre></td></tr></table></figure>
<p>ä¸å¾—ä¸è¯´JSåˆçœäº†ä¸€ç­¹.</p>
<h2 id="Functional-JavaScript"><a href="#Functional-JavaScript" class="headerlink" title="Functional JavaScript"></a>Functional JavaScript</h2><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªreduxåº“ä¸­çš„<code>compose</code>å‡½æ•°</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...funcs</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span> arg =&gt; arg</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">1</span>) &#123;</div><div class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> last = funcs[funcs.length - <span class="number">1</span>]</div><div class="line">  <span class="keyword">const</span> rest = funcs.slice(<span class="number">0</span>, <span class="number">-1</span>)</div><div class="line">  <span class="keyword">return</span> (...args) =&gt; rest.reduceRight((composed, f) =&gt; f(composed), last(...args))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½ èƒ½ä¸€çœ¼çœ‹å‡ºæ¥è¿™ä¸ªå‡½æ•°æ˜¯å¹²å˜›çš„ä¹ˆï¼Ÿ<br>composeå‡½æ•°æ¥æ”¶çš„å‚æ•°æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªå‡½æ•°çš„æ•°ç»„funcsï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œè¿”å›å‡½æ•°çš„å‡½æ•°è¢«ç§°ä¸ºé«˜é˜¶å‡½æ•°.<br>è¿™ä¸ªè¿”å›çš„å‡½æ•°æ¥æ”¶ä»»ä½•å¯èƒ½çš„å‚æ•°ï¼Œé¦–å…ˆè®©funcsæ•°ç»„çš„æœ€åä¸€ä¸ªå‡½æ•°ä½œç”¨äºè¿™äº›å‚æ•°ç”Ÿæˆä¸€ä¸ªbase value(<code>last(...args)</code>),<br>ç„¶åä»å³å¾€å·¦ï¼Œfuncsä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°ä¸€æ¬¡ä½œç”¨äºä¸Šä¸€æ¬¡è°ƒç”¨çš„ç»“æœï¼Œå³<code>f1(f2(f3(f4(base))))</code>, è¿™å°±æ˜¯<code>reduceRight</code>åšçš„äº‹æƒ…ï¼Œå¦‚æœä½ å­¦è¿‡Haskellæˆ–è€…Scalaï¼Œ<br>è¿™ç©æ„å„¿å¯è°“æ˜¯è§æ€ªä¸æ€ªã€‚ å¦‚ä»Šfunctional programmingå·²ç»åœ¨JSä¸­èµ·åˆ°äº†ä¸å¯æ›¿ä»£çš„ä½œç”¨ï¼Œä½ ä¸å¦¨çœ‹çœ‹(RxJS)[<a href="https://github.com/ReactiveX/rxjs]æ˜¯ç©çš„æœ‰å¤šä¹ˆå¦–å¨†" target="_blank" rel="external">https://github.com/ReactiveX/rxjs]æ˜¯ç©çš„æœ‰å¤šä¹ˆå¦–å¨†</a>.</p>
<p>é€šè¿‡è¿™ä¸ªä¾‹å­æˆ‘ä»¬çœ‹åˆ°,JavaScriptç©èµ·é«˜é˜¶å‡½æ•°ä¸€ç‚¹ä¹Ÿä¸å«ç³Š, åŒæ—¶é—­åŒ…ä»æœ‰ä»·å€¼ï¼Œä¸è¿‡æ˜¯åœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸­å¤§æ˜¾èº«æ‰‹è€Œä¸æ˜¯ä½œä¸ºä¸€ä¸ªæ¨¡å—åŒ–çš„æ–¹æ¡ˆè€Œæ˜¾å¾—ä¸ä¼¦ä¸ç±».</p>
<h2 id="Pythonic-Javascript"><a href="#Pythonic-Javascript" class="headerlink" title="Pythonic Javascript"></a>Pythonic Javascript</h2><p>ä»æŸä¸€å¤©å¼€å§‹, æ‰€æœ‰äººéƒ½åœ¨è¯´JavaScriptä¹Ÿæ¥è¶ŠåƒPythonäº†, ä¸æ˜¯ä¹ˆï¼Ÿ</p>
<p>å¯¹æ¯”ä¸€ä¸‹jså’Œpythonç‰ˆ</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> [a, , b] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x, ...y</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> x * y.length;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">let</span> n <span class="keyword">of</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]) &#123;</div><div class="line">  <span class="built_in">console</span>.log(n);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">idMaker</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> index = <span class="number">0</span>;</div><div class="line">  <span class="keyword">while</span>(index &lt; <span class="number">3</span>)</div><div class="line">    <span class="keyword">yield</span> index++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">a, *, b =  [1, 2, 3]</div><div class="line"></div><div class="line">def f(x, *y):</div><div class="line">  return x * len(y)</div><div class="line"></div><div class="line">for n in [1,2,3]:</div><div class="line">  print(n)</div><div class="line"></div><div class="line">def idMaker():</div><div class="line">  index = 0:</div><div class="line">  while x &lt; 3:</div><div class="line">    yield index ++</div></pre></td></tr></table></figure>
<p>é­‚æ·¡ï¼Œæ˜æ˜æ˜¯æˆ‘å…ˆçš„ã€‚ã€‚ä¸è¿‡ä½œä¸ºä¸€ä¸ªPythonç¨‹åºå‘˜, çœ‹åˆ°JSè¿™ä¹ˆèµ¤è£¸è£¸çš„æŠ„è¢­ï¼ŒçœŸçš„æ˜¯å«ä¸€ä¸ªå¼€å¿ƒå•Š!æ¥æŠ„å§ï¼ŒæŠ„ä¸ªç—›å¿«ï¼</p>
<h2 id="Evoling-JavaScript"><a href="#Evoling-JavaScript" class="headerlink" title="Evoling JavaScript"></a>Evoling JavaScript</h2><p>æœ€ç¥å¥‡çš„æ˜¯è¿™é—¨è¯­è¨€çš„è¿›åŒ–é€Ÿåº¦ï¼Œä¸çŸ¥é“ä¸‹æ¬¡åˆæœ‰ä»€ä¹ˆæ–°çš„ææ¡ˆï¼Œæ„Ÿè§‰åœ¨æ¨¡ä»¿Pythonçš„ä¸å½’è·¯ä¸Šå·²ç»è¶Šèµ°è¶Šè¿œâ€¦â€¦</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>JavaScriptï¼Œé‰´äºå…¶ç»§æ‰¿è‡ªCè¯­è¨€ç³»çš„è¯­æ³•ä½“ç³»ï¼Œå¯èƒ½æ°¸è¿œä¸å¯èƒ½åˆ°è¾¾Pythonçš„ä¼˜é›…ç®€æ´ï¼Œä½†æ˜¯å…¶å‘å±•çš„é€Ÿåº¦ï¼Œå´æ—©å·²æŠŠPythonç”©å¼€äº†å‡ æ¡è¡—.  ä½œä¸ºä¸€åPythonç¨‹åºå‘˜ï¼Œæ˜¯æ—¶å€™å­¦ä¹ ä¸€ä¸‹JavaScriptäº†ï¼Œæ¨èä¸€ä¸‹<a href="https://medium.com" target="_blank" rel="external">medium.com</a>, æ¯å¤©è¯»ä¸ªä¸€ä¸¤ç¯‡æ–‡ç« ï¼Œä¿è¯ä½ ä¸ä¼šåæ‚”ã€‚é¡ºä¾¿å®‰åˆ©ä¸€å‘<a href="https://twitter.com/dan_abramov" target="_blank" rel="external">Dan Abramov</a>, reduxå’Œreact hot loaderçš„ä½œè€…ï¼ŒzçœŸå¿ƒä½¿äººé’¦ä½©ã€‚è¿™ä½è€å¸ˆå‘æˆ‘ä»¬å±•ç¤ºäº†ä¸€åä¼˜(é¢œ)ç§€(å€¼)ä¸“(çˆ†)ä¸š(è¡¨)çš„ç¨‹åºå‘˜åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­â€”â€”æ‰å®çš„codingåŸºæœ¬åŠŸï¼Œä¹äºåˆ†äº«çš„ç²¾ç¥ï¼Œå¤©é©¬è¡Œç©ºçš„åˆ›é€ åŠ›,å¯¹é—®é¢˜æ´è‹¥è§‚ç«çš„åˆ¤æ–­åŠ›, æ¸…æ™°çš„è¡¨è¾¾èƒ½åŠ›, ä¸€ä¸ä¸è‹Ÿçš„ä½œé£, å¯¹ç»†èŠ‚çš„ä¸“æ³¨â€¦ğŸ˜‚ å†å¹å°±è¦ä¸Šå¤©äº†ã€‚ã€‚ä¸è¿‡è®²é“ç†å¹ä¸€ä¸‹ä¹Ÿä¸è¿‡åˆ†. å¦‚æœä½ æœ‰å…´è¶£ï¼Œä¸å¦¨å»<a href="https://egghead.io/courses/getting-started-with-redux" target="_blank" rel="external">egghead.io</a>å­¦ä¹ ä¸€ä¸‹reduxï¼Œè‡³äºèƒ½æœ‰å¤šå°‘æ”¶è´§ï¼Œæˆ‘åªèƒ½è¯´é ç¼˜åˆ†ï¼Œä¸è¿‡å³ä¾¿ä½ å¯¹JavaScriptæˆ–è€…ES6æ²¡æœ‰ä»€ä¹ˆå¤§çš„æ¦‚å¿µï¼Œå¬å¬è€å¸ˆçš„è®²è¯¾æ„Ÿå—ä¸€ç‚¹ä»™æ°”ä¹Ÿæ˜¯ä¸é”™çš„ï¼</p>
<p>ä¸ªäººè§‚ç‚¹:å¦‚æœè¯´ä»£ç æ°´å¹³å†³å®šäº†ç¨‹åºå‘˜çš„ä»·å€¼ï¼Œé‚£ä¹ˆäººæ ¼é­…åŠ›å’Œç²¾ç¥è¯‰æ±‚åˆ™æ˜¯ç¨‹åºå‘˜çœŸæ­£çš„ç‘°å®ã€‚. Ask yourself, why are you coding? For money, for fun, for respect, or something else? æ¥ï¼Œå…ˆå¹²äº†è¿™ç¢—é¸¡æ±¤!</p>
<p>ä¸€ä¸å°å¿ƒå°±æ°´äº†ä¸€ç¯‡ï¼Œä¸‹ä¸€ç¯‡å¸¦æ¥å¹²è´§ï¼Œâ€ä½ æ‰€ä¸çŸ¥é“çš„unicodeâ€ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»€ä¹ˆï¼Ÿä½ ä¸æ˜¯Pythonç¨‹åºå‘˜ä¹ˆï¼Œæ€ä¹ˆè·‘è¿‡æ¥å¹JavaScriptäº†ï¼Ÿçªƒä»¥ä¸ºåªæœ‰å¹¼ç¨šçš„ç¨‹åºå‘˜æ‰ä¼šåæ‰§äºä¸€ä¸¤é—¨è¯­è¨€ï¼Œæ•…æ­¥è‡ªå°ï¼Œä¼˜ç§€çš„ç¨‹åºå‘˜å°±ä¼šçŸ¥é“åšè§ˆä¼—é•¿ï¼Œçº³ä¸ºå·±ç”¨ã€‚ JavaScriptï¼Œ è¿™é—¨ç¥å¥‡çš„è¯­è¨€ï¼Œä»20å¹´å‰ä¸€ä¸ªç¤¼æ‹œå°±è®¾è®¡å®Œæˆçš„ç©å…·è¯­è¨€ï¼Œç»è¿‡å²æœˆçš„æ´—ç¤¼ï¼Œå¦‚ä»Šå·²ç»ç™»ä¸Šå¤§é›…ä¹‹å ‚ï¼Œä»æµè§ˆå™¨åˆ°æœåŠ¡å™¨ï¼Œç”šè‡³åˆ°åµŒå…¥å¼ç³»ç»Ÿï¼ŒJavaScriptæ— å¤„ä¸åœ¨ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºå‘˜ç°åœ¨è¿˜å¯¹JavaScriptä¸å±‘ä¸€é¡¾æˆ–è€…ä¸å»å­¦ä¹ ä¸€ä¸‹(ä¹Ÿè®¸æ”¾åˆ°ä¸¤ä¸‰å¹´å‰è¿™å¹¶ä¸æ˜¯ä»€ä¹ˆé—®é¢˜)ï¼Œæ„Ÿè§‰å¯ä»¥å›å»åçœä¸€ä¸‹ã€‚&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>å®ç°ä¸€ä¸ªç®€å•ä¼˜é›…çš„Flaskè¡¨å•éªŒè¯æ¨¡å—</title>
    <link href="http://imiliya.com/2016/08/23/flask-form/"/>
    <id>http://imiliya.com/2016/08/23/flask-form/</id>
    <published>2016-08-22T16:40:43.000Z</published>
    <updated>2016-09-02T19:57:59.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ç”¨Flaskæ¡†æ¶å¼€å‘webåº”ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šåœ¨è§†å›¾å±‚å†™å¾ˆå¤šç¹ççš„ä»£ç æ¥æ ¡éªŒè¡¨å•çš„æ•°æ®ï¼ŒåŒæ—¶æŠŠæäº¤çš„æ•°æ®è½¬æ¢æˆä¸šåŠ¡éœ€è¦çš„æ ¼å¼, ç»“æœå°±æ˜¯è§†å›¾å±‚çš„ä»£ç åˆ°å¤„å¤¹æ‚ç€è¡¨å•éªŒè¯çš„é€»è¾‘ï¼Œæ˜¾å¾—é”™ç»¼å¤æ‚ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚æ³¨æ„æˆ‘æ‰€æŒ‡çš„è¡¨å•æ˜¯æ›´åŠ å¹¿ä¹‰çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬query stringæˆ–è€…é€šè¿‡è®¾ç½®Content-Typeä¸º<code>application/json</code>ä¼ é€’çš„æ•°æ®ã€‚å…ˆæ¥çœ‹ä¸€ä¸ªæ ·ä¾‹:</p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</div><div class="line"><span class="meta">@app.route('/register', methods=['POST'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></div><div class="line">    username = request.form.get(<span class="string">'username'</span>)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</div><div class="line">      <span class="keyword">raise</span> ValueError(<span class="string">'username cannot be empty'</span>)</div><div class="line">    <span class="keyword">if</span> len(username) &gt; <span class="number">10</span>:</div><div class="line">      <span class="keyword">raise</span> ValueError(<span class="string">'username should be less than 10'</span>)</div><div class="line">    password = request.form.get(<span class="string">'password'</span>)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> password:</div><div class="line">      <span class="keyword">raise</span> ValueError(<span class="string">'password cannot be empty'</span>)</div><div class="line">    <span class="keyword">if</span> len(password) &lt; <span class="number">10</span>:</div><div class="line">      <span class="keyword">raise</span> ValueError(<span class="string">'username should be longer than 10'</span>)</div><div class="line">    age = request.form.get(<span class="string">'age'</span>)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> age:</div><div class="line">      <span class="keyword">raise</span> ValueError(<span class="string">'age should not be empty'</span>)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">      age = int(age)</div><div class="line">    <span class="keyword">except</span> (TypeError, ValueError):</div><div class="line">      <span class="keyword">raise</span> ValueError(<span class="string">'age should be an integer'</span>)</div><div class="line">    from_ = request.args.get(<span class="string">'from'</span>)</div><div class="line">    <span class="keyword">if</span> from_ <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'qq'</span>, <span class="string">'weibo'</span>, <span class="string">'native'</span>):</div><div class="line">      <span class="keyword">raise</span> ValueError(<span class="string">'invalid from'</span>)</div><div class="line">    <span class="keyword">if</span> from_ == <span class="string">'weibo'</span></div><div class="line">      register_weibo(username, password, age)</div><div class="line">    <span class="keyword">if</span> from_ == <span class="string">'qq'</span>:</div><div class="line">      register_qq(username, password, age)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">      register_native(username, passowrd, age)</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬èŠ±è´¹äº†å¤§é‡çš„ç²¾åŠ›åœ¨è·å–å’ŒéªŒè¯username, age, passwordå’Œfrom_è¿™å‡ ä¸ªå­—æ®µï¼Œ registerçš„viewå±‚çœ‹ä¸Šå»å°±æ„Ÿè§‰å¾ˆæ··ä¹±ï¼Œè¦æ”¹åŠ¨æŸä¸ªå­—æ®µçš„éªŒè¯é€»è¾‘ï¼Œè¿˜è¦åœ¨registerå‡½æ•° ä¸­æ‰¾åˆ°å¯¹åº”è¿™ä¸ªå­—æ®µçš„éªŒè¯ä»£ç ã€‚æœ‰æ²¡æœ‰åŠæ³•æŠŠè¡¨å•éªŒè¯çš„é€»è¾‘ä»è§†å›¾å±‚æŠ½ç¦»å‡ºå»ï¼Œè®©è§†å›¾å±‚åªåšdispatchçš„å·¥ä½œå‘¢ï¼Ÿ</p>
<p>æœ‰djangoå¼€å‘ç»éªŒçš„åŒå­¦ä¼šæƒ³é‚£å°±æ¥å†™ä¸ªmiddlewareå§ï¼ŒFlaskå…¶å®ä¹Ÿæä¾›äº†middlewareæœºåˆ¶ï¼Œ ä¸è¿‡è¿™ä¸ªmiddlewareæ˜¯åº•å±‚werkzeugåº“å°è£…çš„wsgiä¸­é—´ä»¶ï¼Œä¸èƒ½å¾ˆå¥½åœ°å’Œflaskæ¡†æ¶çš„ä¸Šä¸‹æ–‡ç»“åˆèµ·æ¥ã€‚ å…¶å®æˆ‘ä»¬å®Œå…¨å¯ä»¥ä»Pythonè¯­è¨€å±‚é¢è§¦å‘ï¼Œåˆ©ç”¨Pythonå¼ºå¤§çš„æŠ½è±¡èƒ½åŠ›ï¼Œç”¨æœ€ç®€å•çš„æ–¹å¼è§£å†³é—®é¢˜ã€‚å¯¹ï¼Œ ä½ æ˜¯ä¸æ˜¯ä¹Ÿæƒ³åˆ°äº†ï¼ŒPythonçš„ä¸‡é‡‘æ²¹å¤§æ€å™¨â€”â€”decorator!</p>
<p>å¦‚æœèƒ½åœ¨viewå‡½æ•°ä¸Šé¢å¥—ä¸€ä¸ªdecoratorå°±èƒ½æŠŠè¡¨å•éªŒè¯çš„æ´»å¹²äº†ï¼Œviewå±‚çš„ä»£ç å°±ä¼šè½»ä¾¿å¾ˆå¤šã€‚ æˆ‘ä»¬è¯•ç€è®¾è®¡ä¸€ä¸‹è¿™ä¸ªdecoratorçš„APIã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> some_where <span class="keyword">import</span> form</div><div class="line"><span class="meta">@app.route('/register', methods=['POST'])</span></div><div class="line"><span class="meta">@RegisterForm</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></div><div class="line">   username = form.username</div><div class="line">   password = form.passoword</div><div class="line">   from_ = form.<span class="keyword">from</span></div><div class="line">   age = form.age</div><div class="line">   <span class="comment"># register_logic...</span></div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¸Œæœ›é€šè¿‡å£°æ˜å¼çš„æ–¹æ³•æ¥å®šä¹‰è¡¨å•éªŒè¯çš„é€»è¾‘</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span>:</span></div><div class="line">    username = String(<span class="string">'form'</span>, required=<span class="keyword">True</span>, max_length=<span class="number">10</span>)</div><div class="line">    password = String(<span class="string">'form'</span>, required=<span class="keyword">True</span>, min_length=<span class="number">10</span>)</div><div class="line">    age = Int(<span class="string">'form'</span>, required=<span class="keyword">True</span>)</div><div class="line">    from_ = String(<span class="string">'args'</span>, required=<span class="keyword">True</span>, enums=(<span class="string">'qq'</span>, <span class="string">'weibo'</span>, <span class="string">'native'</span>))</div></pre></td></tr></table></figure>
<p><code>form</code>å’Œ<code>args</code>åˆ†åˆ«è¡¨ç¤ºä»formDataå’Œquerystringè·å–æ•°æ®ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿå®ç°<code>RegisterForm</code>, <code>String</code>, <code>Int</code>çš„åŠŸèƒ½, è®©å¼€å‘è€…åªéœ€è¦å£°æ˜<code>RegisterForm</code>å’Œå¯¹åº”çš„å­—æ®µå°±èƒ½å®Œæˆè¡¨å•éªŒè¯çš„å·¥ä½œ, é‚£ä¹ˆè§†å›¾å±‚å°±èƒ½å®Œå…¨è§£è„±å‡ºæ¥ï¼ŒåŒæ—¶å£°æ˜å¼çš„è¡¨å•ç±»ä¹Ÿæ›´å®¹æ˜“ç»´æŠ¤ã€‚è‡³å°‘ä¸Šé¢çš„registerå‡½æ•°å’ŒRegisterFormå·²ç»éå¸¸èµå¿ƒæ‚¦ç›®äº†, è€Œä¸”ååˆ†Pythonicã€‚</p>
<p>Ok, é¥¼å·²ç»ç”»å¥½ï¼Œç°åœ¨æˆ‘ä»¬æ¥å¡«å‘å§, æ•´ä¸ªå®ç°çš„ä»£ç ä¼šç”¨åˆ°ä¸€äº›æ¯”è¾ƒé«˜çº§çš„è¯­è¨€ç‰¹æ€§ï¼Œæ¯”å¦‚descriptorå’Œmetaclassï¼Œå»ºè®®è¯»è€…å…ˆç†Ÿæ‚‰æˆ–æ¸©ä¹ ä¸€ä¸‹ç›¸å…³å†…å®¹ã€‚åŒæ—¶ä¹Ÿä¼šç”¨åˆ°ä¸€äº›Python3 onlyçš„ä¸œè¥¿, ä¹Ÿè®¸èƒ½å¤Ÿæ¿€å‘ä¸€ä¸‹ä½ å¯¹Python3çš„å¥½å¥‡å¿ƒ!</p>
<h2 id="Test-first"><a href="#Test-first" class="headerlink" title="Test first"></a>Test first</h2><p>è™½ç„¶æˆ‘ä¸æ˜¯TDDçš„å¿ å®æ‹¥è¶¸ï¼Œä½†è¿˜æ˜¯å…ˆæ¥å‡ ä¸ªæµ‹è¯•ç”¨ä¾‹å‹å‹æƒŠ:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> flask</div><div class="line"><span class="keyword">import</span> pytest</div><div class="line"></div><div class="line"><span class="keyword">from</span> forms <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_form</span><span class="params">()</span>:</span></div><div class="line">    app = flask.Flask(__name__)</div><div class="line">    app.testing = <span class="keyword">True</span></div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BasicForm</span><span class="params">(Form)</span>:</span></div><div class="line">        a = IntField(<span class="string">'args'</span>, required=<span class="keyword">True</span>, name=<span class="string">'a'</span>)</div><div class="line">        b = StringField(<span class="string">'args'</span>, required=<span class="keyword">True</span>)</div><div class="line">        c = StringField(<span class="string">'args'</span>, required=<span class="keyword">False</span>, default=<span class="string">'default'</span>)</div><div class="line">        d = FloatField(<span class="string">'args'</span>, required=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RequireForm</span><span class="params">(Form)</span>:</span></div><div class="line">        x = StringField(<span class="string">'args'</span>, required=<span class="keyword">True</span>, default=<span class="string">'default'</span>)</div><div class="line"></div><div class="line"><span class="meta">    @app.route('/')</span></div><div class="line"><span class="meta">    @BasicForm</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">assert</span> form.a == <span class="number">10</span></div><div class="line">        <span class="keyword">assert</span> form.b == <span class="string">'hello'</span></div><div class="line">        <span class="keyword">assert</span> form.c == <span class="string">'default'</span></div><div class="line">        <span class="keyword">assert</span> form.d == <span class="number">12.5</span></div><div class="line">        <span class="keyword">return</span> <span class="string">''</span></div><div class="line"></div><div class="line">    <span class="keyword">with</span> app.test_client() <span class="keyword">as</span> c:</div><div class="line">        c.get(<span class="string">'/?a=10&amp;b=hello&amp;d=12.5'</span>)</div><div class="line"></div><div class="line"><span class="meta">    @app.route('/require')</span></div><div class="line"><span class="meta">    @RequireForm</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">require</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> str(form.x)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> app.test_client() <span class="keyword">as</span> c:</div><div class="line">        <span class="keyword">with</span> pytest.raises(ValidationError):</div><div class="line">            c.get(<span class="string">'/require'</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">SizeForm</span><span class="params">(Form)</span>:</span></div><div class="line">        s = IntField(<span class="string">'args'</span>, min_val=<span class="number">5</span>,max_val=<span class="number">10</span>)</div><div class="line"></div><div class="line"><span class="meta">    @app.route('/size')</span></div><div class="line"><span class="meta">    @SizeForm</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">size</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">assert</span> form.s == <span class="number">5</span></div><div class="line">        <span class="keyword">return</span> <span class="string">''</span></div><div class="line"></div><div class="line">    <span class="keyword">with</span> app.test_client() <span class="keyword">as</span> c:</div><div class="line">        c.get(<span class="string">'/size?s=5'</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ListForm</span><span class="params">(Form)</span>:</span></div><div class="line">        l = CSVListField(<span class="string">'args'</span>, each_field=IntField, description=<span class="string">'list'</span>)</div><div class="line"></div><div class="line"><span class="meta">    @app.route('/list')</span></div><div class="line"><span class="meta">    @ListForm</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list_form</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">assert</span> form.l == [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</div><div class="line">        <span class="keyword">return</span> <span class="string">''</span></div><div class="line"></div><div class="line">    <span class="keyword">with</span> app.test_client() <span class="keyword">as</span> c:</div><div class="line">        c.get(<span class="string">'/list?l=1,2,3'</span>)</div></pre></td></tr></table></figure>
<p>å®ç°äº†TDDå¤§æ³•çš„ç¬¬ä¸€æ­¥<span style="color:red">red</span>ï¼Œç„¶åæˆ‘ä»¬è¦åšçš„å°±æ˜¯æƒ³åŠæ³•æŠŠä»–å˜<span style="color:green">ç»¿</span>ã€‚</p>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>éœ€è¦å®ç°çš„Formç±»æ˜¯ä¸€ä¸ªdecoratorï¼Œç›´æ¥ä½œç”¨äºviewå‡½æ•°ï¼Œé‚£ä¹ˆç»“æœè‚¯å®šéœ€è¦ä¸€ä¸ª<code>callable</code>å¯¹è±¡ï¼Œ æ‰€ä»¥éœ€è¦ç»™Formç±»å¢åŠ ä¸€ä¸ª<code>__call__</code>æ–¹æ³•ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Form</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, view_func)</span>:</span></div><div class="line">        self._view_func = view_func</div><div class="line">        functools.update_wrapper(self, view_func)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> self._view_func(*args, **kwargs)</div></pre></td></tr></table></figure>
<p>Ok, çœ‹ä¸Šå»å¥½åƒä»€ä¹ˆä¹Ÿæ²¡åšä»€ä¹ˆçš„ã€‚ä¸è¿‡è¿˜è®°å¾—ä¹‹å‰çš„<code>from some_where import form</code>ä¹ˆï¼Œè¿™ä¸ªformå¯¹è±¡åˆæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿæ€ä¹ˆå¯ä»¥ç›´æ¥importè¿›æ¥ç”¨äº†ï¼Œå®ƒä¸æ˜¯å…¨å±€å˜é‡ä¹ˆï¼Ÿä¸ï¼Œä½ ä¼¼ä¹å¿˜äº†æœ‰ä¸€ä¸ªå«åš <strong>thread(greenlet)local</strong> çš„ä¸œè¥¿ã€‚Flaskæ¡†æ¶å°è£…äº†threadlocalï¼Œæä¾›äº†æ›´åŠ é«˜çº§çš„APIç»™å¼€å‘è€…ä½¿ç”¨ï¼Œæ¯”å¦‚<code>flask.request</code>å°±æ˜¯ä¸€ä¸ªthreadlocalï¼Œ æˆ‘ä»¬çš„formå¯¹è±¡å…¶å®å°±æ˜¯æ¨¡æ‹Ÿäº†<code>flask.request</code>çš„æœºåˆ¶ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask.globals <span class="keyword">import</span> _app_ctx_stack, _app_ctx_err_msg</div><div class="line"><span class="keyword">from</span> werkzeug.local <span class="keyword">import</span> LocalProxy</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_lookup_current_form</span><span class="params">()</span>:</span></div><div class="line">    top = _app_ctx_stack.top</div><div class="line">    <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</div><div class="line">    <span class="keyword">return</span> getattr(top, <span class="string">'form'</span>, <span class="keyword">None</span>)</div><div class="line"></div><div class="line"></div><div class="line">form = LocalProxy(_lookup_current_form)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Form</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        _app_ctx_stack.top.form = self</div><div class="line">        <span class="keyword">return</span> self._view_func(*args, **kwargs)</div></pre></td></tr></table></figure>
<p>åœ¨è°ƒç”¨viewå‡½æ•°ä¹‹å‰å…ˆæŠŠFormå®ä¾‹ä¸¢åˆ°app contextçš„æ ˆé¡¶ï¼Œ<code>form = LocalProxy(_lookup_current_form)</code>é‡Œçš„formæ˜¯ä¸€ä¸ªthreadlocalçš„å…¨å±€å˜é‡ï¼Œå› ä¸ºæ¯ä¸ªè¯·æ±‚åªä¼šæäº¤ä¸€ä¸ªè¡¨å•ï¼Œæ‰€ä»¥æ¯ä¸ªè¯·æ±‚å¯¹åº”äº†ä¸€ä¸ªthreadlocalçš„formå¯¹è±¡ï¼Œ å…³äºflaskçš„app contextå’Œrequest contextï¼Œå¸Œæœ›è¯»è€…è‡ªå·±å»åšä¸€ç‚¹åŠŸè¯¾ï¼Œè¦æŠŠæ‰€æœ‰ä¸œè¥¿éƒ½è®²ä¸€éæ˜¯åœ¨å¤ªç´¯ï¼Œ æ‰€ä»¥æˆ‘æ˜¯å‡è®¾è¯»è€…å…·å¤‡ä¸€å®šçš„åŸºç¡€ï¼Œ è¿™æ ·äº¤æµèµ·æ¥æ¯”è¾ƒè½»æ¾ä¸€ç‚¹ã€‚</p>
<p>ä»æš´éœ²çš„APIçœ‹åˆ°ï¼Œ<code>username</code>å’Œ<code>password</code>æ˜¯å…¨å±€formå¯¹è±¡çš„å±æ€§ï¼Œæ€ä¹ˆæ‰èƒ½åœ¨<code>form.username</code>çš„æ—¶å€™å»ä»requesté‡Œé¢æ‹¿åˆ°usernameçš„æ•°æ®å¹¶åšç©éªŒè¯æœ€åè¿”å›è¿™ä¸ªæ•°æ®å‘¢ï¼Ÿæ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ‹¦æˆªæœºåˆ¶æ¥ä»£ç†å¯¹usernameçš„è®¿é—®ï¼Œåœ¨Pythoné‡Œé¢ï¼Œæœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯é€šè¿‡descriptorçš„<code>__get__</code>æ–¹æ³•.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">_none_value = object()</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FormField</span>:</span></div><div class="line">    VALID_SOURCES = (<span class="string">'args'</span>, <span class="string">'form'</span>, <span class="string">'json'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, source=<span class="string">''</span>, *, name=<span class="string">''</span>, required=True,</span></span></div><div class="line">                 default=None, description=<span class="string">''</span>):</div><div class="line">        <span class="keyword">if</span> source <span class="keyword">and</span> source <span class="keyword">not</span> <span class="keyword">in</span> self.VALID_SOURCES:</div><div class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'request source %s is not valid'</span> % source)</div><div class="line">        self.source = source <span class="keyword">or</span> <span class="string">'json'</span></div><div class="line">        self.required = required</div><div class="line">        self.default = default</div><div class="line">        self.description = description</div><div class="line">        self.name = name</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></div><div class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'form field attribute is readonly'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_request_data</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(request, self.source):</div><div class="line">            <span class="keyword">raise</span> ValidationError(</div><div class="line">                <span class="string">'%s is not a valid data source from request'</span> % self.source)</div><div class="line">        <span class="keyword">if</span> self.source == <span class="string">'json'</span> <span class="keyword">and</span> request.get_json(silent=<span class="keyword">True</span>) <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            source = <span class="string">'form'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            source = self.source</div><div class="line">        req_data = getattr(request, source)</div><div class="line">        <span class="comment"># request.args or request.form</span></div><div class="line">        <span class="keyword">if</span> hasattr(req_data, <span class="string">'getlist'</span>):</div><div class="line">            raw = req_data.getlist(self.name)</div><div class="line">            <span class="keyword">if</span> len(raw) == <span class="number">1</span>:</div><div class="line">                <span class="keyword">return</span> raw[<span class="number">0</span>]</div><div class="line">            <span class="keyword">if</span> len(raw) == <span class="number">0</span>:</div><div class="line">                <span class="keyword">return</span> _none_value</div><div class="line">            <span class="comment"># ä¸æ”¯æŒå¤šä¸ªå€¼çš„è¡¨å•å­—æ®µ, è¯·ç”¨csvä»£ç†</span></div><div class="line">            <span class="keyword">raise</span> ValidationError(</div><div class="line">                <span class="string">'multi values form field %s is not to be supported!'</span> % self.name)</div><div class="line">        <span class="comment"># request.json</span></div><div class="line">        <span class="keyword">return</span> req_data.get(self.name, _none_value)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, _)</span>:</span></div><div class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> self</div><div class="line">        name = self.name</div><div class="line">        data = self._get_request_data()</div><div class="line"></div><div class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> _none_value:</div><div class="line">            <span class="keyword">if</span> self.required:</div><div class="line">                <span class="keyword">raise</span> ValidationError(<span class="string">'FIELD %s is required'</span> % name)</div><div class="line">            <span class="comment"># return default directly</span></div><div class="line">            self.__dict__[name] = self.default</div><div class="line">            <span class="keyword">return</span> self.default</div><div class="line"></div><div class="line">        result = self.process(data)</div><div class="line">        self.__dict__[name] = result</div><div class="line">        <span class="keyword">return</span> result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="keyword">return</span> data</div></pre></td></tr></table></figure></p>
<p>FormFieldæ˜¯ä¸€ä¸ªBaseClassï¼Œæ³¨æ„åˆ°<code>__init__</code>æ–¹æ³•çš„æ ‡ç­¾äº†ä¹ˆï¼Œ<code>def __init__(self, source=&#39;&#39;, *, name=&#39;&#39;...</code>ä¸­ â€˜*â€˜ çš„æ„æ€æ˜¯åé¢çš„å‚æ•°å¿…é¡»æ˜¯keywordçš„æ–¹å¼ä¼ è¿›æ¥ï¼Œ<code>FormField(&#39;args&#39;, name=&#39;username&#39;)</code> is Ok while <code>FormField(&#39;args&#39;, &#39;username&#39;)</code> is not. è¿™ä¸ªPython3çš„æ–°ç‰¹æ€§å¸¦æ¥çš„å¥½å¤„æ˜¯é€šè¿‡å°†æŸäº›å‚æ•°è®¾è®¡æˆkeyword onlyçš„å½¢å¼ï¼Œä½¿APIæ›´åŠ æ¸…æ™°æ˜äº†ï¼Œé™ä½äº†è°ƒç”¨æ–¹é”™è¯¯ä¼ å‚çš„å¯èƒ½æ€§ã€‚ <code>__get___</code>æ–¹æ³•æ‹¦æˆªäº†å¯¹<code>FormField</code>å®ä¾‹çš„è®¿é—®ï¼Œ<code>_get_request_data</code>è§£ærequestæ¥è·å–åŸå§‹æ•°æ®ï¼Œ <code>_none_value</code>è¿™ä¸ªå“¨å…µè¡¨ç¤ºrequestä¸­æ‰¾ä¸åˆ°å¯¹åº”å­—æ®µã€‚è§£æå®Œrequestä¹‹åï¼Œéœ€è¦è°ƒç”¨<code>process</code>æ–¹æ³•æ¥å¯¹æ•°æ®åšæ ¡éªŒå’Œè½¬åŒ–ï¼Œå­ç±»é€šè¿‡overrideè¿™ä¸ªæ–¹æ³•æ¥å®ç°è‡ªå·±çš„æ ¡éªŒé€»è¾‘ã€‚ <code>self.__dict__[name] = result</code>è¿™ä¸€æ­¥ååˆ†trickyï¼Œ é€šè¿‡æŠŠç»“æœç›´æ¥æ”¾åˆ°formå¯¹è±¡çš„<code>__dict__</code>å±æ€§ä¸­ï¼Œä¸‹æ¬¡è®¿é—®åŒåå±æ€§çš„æ—¶å€™å°±ç›´æ¥ä»<code>__dict__</code>ä¸­å–å‡ºè¿”å›ï¼Œè€Œä¸éœ€è¦å†èµ°ä¸€édescriptorçš„<code>__get__</code>æ–¹æ³•äº†ã€‚</p>
<p>ä¸‹é¢æ˜¯å­ç±»çš„å®ç°<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LengthLimitedField</span><span class="params">(FormField)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, source=<span class="string">''</span>, *, min_length=None, max_length=None, **kwargs)</span>:</span></div><div class="line">        self.min = min_length</div><div class="line">        self.max = max_length</div><div class="line">        super().__init__(source, **kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="keyword">if</span> self.max <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> len(data) &gt; self.max:</div><div class="line">            <span class="keyword">raise</span> ValidationError(</div><div class="line">                <span class="string">'FIELD &#123;&#125; is limited to max length &#123;&#125; but actually is &#123;&#125;'</span>.format(  <span class="comment"># noqa</span></div><div class="line">                    self.name, self.max, len(data)))</div><div class="line">        <span class="keyword">if</span> self.min <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> len(data) &lt; self.min:</div><div class="line">            <span class="keyword">raise</span> ValidationError(</div><div class="line">                <span class="string">'FIELD &#123;&#125; is limited to min length &#123;&#125; but actually is &#123;&#125;'</span>.format(  <span class="comment"># noqa</span></div><div class="line">                    self.name, self.min, len(data)))</div><div class="line"></div><div class="line">        <span class="keyword">return</span> super().process(data)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SizedField</span><span class="params">(FormField)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, source=<span class="string">''</span>, *, min_val=None, max_val=None,</span></span></div><div class="line">                 inc_min=True, inc_max=True, **kwargs):</div><div class="line">        self.min = min_val</div><div class="line">        self.max = max_val</div><div class="line">        self.inc_min = inc_min</div><div class="line">        self.inc_max = inc_max</div><div class="line">        super().__init__(source, **kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="keyword">if</span> self.max <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            invalid = data &gt; self.max <span class="keyword">if</span> self.inc_max <span class="keyword">else</span> data &gt;= self.max</div><div class="line">            <span class="keyword">if</span> invalid:</div><div class="line">                <span class="keyword">raise</span> ValidationError(</div><div class="line">                    <span class="string">'FIELD &#123;&#125; is limited to max value &#123;&#125; but actually is &#123;&#125;'</span>.format(</div><div class="line">                        self.name, self.max, data))</div><div class="line">        <span class="keyword">if</span> self.min <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            invalid = data &lt; self.min <span class="keyword">if</span> self.inc_min <span class="keyword">else</span> data &lt;= self.min</div><div class="line">            <span class="keyword">if</span> invalid:</div><div class="line">                <span class="keyword">raise</span> ValidationError(</div><div class="line">                    <span class="string">'FIELD &#123;&#125; is limited to min value &#123;&#125; but actually is &#123;&#125;'</span>.format(</div><div class="line">                        self.name, self.min, data))</div><div class="line">        <span class="keyword">return</span> super().process(data)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TypedField</span><span class="params">(FormField)</span>:</span></div><div class="line">    field_type = type(<span class="keyword">None</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            data = self.field_type(data)</div><div class="line">            <span class="keyword">return</span> super().process(data)</div><div class="line">        <span class="keyword">except</span> (TypeError, ValueError):</div><div class="line">            <span class="keyword">raise</span> ValidationError(</div><div class="line">                <span class="string">'FIELD &#123;&#125; cannot be converted to &#123;&#125;'</span>.format(</div><div class="line">                    self.name, self.field_type</div><div class="line">                )</div><div class="line">            )</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntField</span><span class="params">(TypedField, SizedField)</span>:</span></div><div class="line">    field_type = int</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FloatField</span><span class="params">(TypedField, SizedField)</span>:</span></div><div class="line">    field_type = float</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicStringField</span><span class="params">(TypedField)</span>:</span></div><div class="line">    field_type = str</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoolField</span><span class="params">(TypedField)</span>:</span></div><div class="line">    field_type = bool</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringField</span><span class="params">(BasicStringField, LengthLimitedField)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CSVListField</span><span class="params">(FormField)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, source=<span class="string">''</span>, *, each_field, **kwargs)</span>:</span></div><div class="line">        self.each_field = each_field</div><div class="line">        super().__init__(source, **kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(self, data)</span>:</span></div><div class="line">        data_list = data.split(<span class="string">','</span>)</div><div class="line">        <span class="keyword">if</span> isinstance(self.each_field, FormField):</div><div class="line">            each_field = self.each_field</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            each_field = self.each_field(source=self.source)</div><div class="line">        <span class="keyword">return</span> [each_field.process(elem) <span class="keyword">for</span> elem <span class="keyword">in</span> data_list]</div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢æä¾›äº†ä¸€äº›åŸºæœ¬çš„å­—æ®µç±»å‹, æ‹“å±•èµ·æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œåªéœ€è¦ç»„åˆå·²æœ‰ç±»å‹æˆ–è€…åœ¨æ–°çš„ç±»å‹ä¸­è¦†å†™<code>process</code>æ–¹æ³•ã€‚ <code>super()</code>æ–¹æ³•ä¹Ÿæ˜¯Python3 onlyçš„ï¼Œæˆ‘ä»¬çœ‹åˆ°<code>IntField</code>ç»§æ‰¿äº†TypedFieldå’ŒSizedFieldä¸¤ä¸ªç±»ï¼Œæ¯ä¸ªç±»çš„<code>process</code>æ–¹æ³•éƒ½å…ˆåšäº†è‡ªå·±çš„æ ¡éªŒï¼Œç„¶åä¸¢ç»™<code>super()</code>ã€‚é‚£ä¹ˆTypedFieldå’ŒSizedFieldçš„processæ–¹æ³•éƒ½ä¼šè°ƒç”¨ä¹ˆï¼Œå…ˆè°ƒç”¨å“ªä¸€ä¸ªå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>IntField</code>çš„<code>__mro__</code>å±æ€§çŸ¥é“è°ƒç”¨é¡ºåºã€‚</p>
<pre><code>In [1]: IntField.__mro__
Out[1]:
(zeus.core.forms.IntField,
 zeus.core.forms.TypedField,
 zeus.core.forms.SizedField,
 zeus.core.forms.FormField,
 object)
</code></pre><p>æ‰€ä»¥è°ƒç”¨é¡ºåºæ˜¯<code>TypedField.process</code> -&gt; <code>SizedField.process</code> -&gt; <code>Form.process</code>ã€‚å…³äº<code>mro</code>çš„æœºåˆ¶ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº†ã€‚</p>
<p>è¿˜è®°å¾—æˆ‘ä»¬çš„APIä¹ˆï¼Œå›é¡¾ä¸€ä¸‹Fieldçš„ä½¿ç”¨å§¿åŠ¿</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span>:</span></div><div class="line">    username = StringField(<span class="string">'form'</span>, required=<span class="keyword">True</span>, max_length=<span class="number">10</span>)</div><div class="line">    password = StringField(<span class="string">'form'</span>, required=<span class="keyword">True</span>, min_length=<span class="number">10</span>)</div><div class="line">    age = IntField(<span class="string">'form'</span>, required=<span class="keyword">True</span>)</div><div class="line">    from_ = StringField(<span class="string">'args'</span>, required=<span class="keyword">True</span>, enums=(<span class="string">'qq'</span>, <span class="string">'weibo'</span>, <span class="string">'native'</span>))</div></pre></td></tr></table></figure>
<p>æ³¨æ„æˆ‘ä»¬å¹¶æ²¡æœ‰æŠŠå­—æ®µçš„nameä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œ é‚£ä¹ˆFormFieldåˆæ€ä¹ˆçŸ¥é“å­—æ®µçš„åå­—æ˜¯ä»€ä¹ˆå‘¢? åˆåˆ°äº†ä½¿ç”¨é»‘è†œæ³•çš„æ—¶å€™ï¼Œè™½ç„¶æˆ‘ä¸€å†æ‰¿è¯ºä¸ç‡å…ˆä½¿ç”¨metaclassã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FormFieldMeta</span><span class="params">(type)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></div><div class="line">        <span class="keyword">for</span> field, value <span class="keyword">in</span> attrs.items():</div><div class="line">            <span class="keyword">if</span> isinstance(value, FormField):</div><div class="line">                value.name = field</div><div class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Form</span><span class="params">(metaclass=FormFieldMeta)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, view_func)</span>:</span></div><div class="line">        self._view_func = view_func</div><div class="line">        functools.update_wrapper(self, view_func)</div></pre></td></tr></table></figure></p>
<p><code>FormFieldMeta</code>åœ¨<code>Form</code>ç±»åˆ›å»ºçš„æ—¶å€™ï¼Œéå†äº†<code>Form</code>çš„å±æ€§ï¼Œå¦‚æœå‘ç°<code>FormField</code>å°±æŠŠå¯¹åº”çš„å±æ€§åè®¾ä¸º<code>FormField</code>çš„nameå­—æ®µï¼Œæ‰€ä»¥åƒä¸‡åˆ«ä»¥ä¸ºmetaclassæœ‰å¤šé«˜æ·±ï¼Œå…¶å®æ˜¯å¾ˆç®€å•çš„ç©å„¿ã€‚ï¼ˆå½“ç„¶æˆ‘å‡è®¾ä½ æœ‰äº†è§£è¿‡metaclassçš„åŸç†ï¼‰ã€‚</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>Congrats! Weâ€™are done! æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå£°æ˜å¼çš„åŸºäºdecoratorçš„flaskè¡¨å•éªŒè¯æ¨¡å—ã€‚ä½ å¯ä»¥è¯•è¯•ç°åœ¨å†è·‘ä¸€ä¸‹ä¹‹å‰çš„æµ‹è¯•ç”¨ä¾‹ã€‚ç›¸å…³ä»£ç è¯·å‚è€ƒ<a href="https://github.com/moonshadow/way-to-python-ninja/tree/master/advanced-flask/form" target="_blank" rel="external">flask form</a>ã€‚ å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥èµ°TDDçš„ç¬¬ä¸‰æ­¥â€”â€”refactoräº†, enjoy yourself!ã€‚</p>
<p>å›é¡¾ä¸€ä¸‹ï¼Œä¸ºäº†å®ç°è¿™ä¸ªæ¨¡å—ï¼Œæˆ‘ä»¬ç”¨åˆ°äº†decoratorï¼Œdescriptorï¼Œ metaclassï¼Œkeyword only argument, å¤šé‡ç»§æ‰¿ï¼Œmro, flaskçš„context globalâ€¦ åº†ç¥ä¸€ä¸‹æˆ‘ä»¬çš„æˆæœå§ï¼å¦‚æœä½ å¯¹æ•´ä¸ªæ¨¡å—çš„å®ç°éƒ½å·²ç»äº†ç„¶äºèƒ¸ï¼Œæ­å–œä½ ï¼ŒYouâ€™are a Python veteran now! å¦‚æœä½ è¿˜æœ‰å¾ˆå¤šå›°æƒ‘æˆ–è€…æ„Ÿè§‰ä¸¾æ­¥ç»´è‰°ï¼Œä¹Ÿä¸è¦ç€æ€¥ï¼ŒæŠŠæ¯ä¸ªç‚¹çš„åŠŸè¯¾ä¸€ä¸ªä¸€ä¸ªåšå¥½ï¼Œå¤šåŠ¨è„‘ç­‹æ€è€ƒ, è¯•ç€ä»¥ç†è§£è¿™ä¸ªæ¨¡å—ä¸ºç›®æ ‡å¥½å¥½åœ°å­¦ä¸€æ³¢Pythonå§, it deserves! I promiseã€‚</p>
<p>Anyway, å¦‚æœä½ æœ‰æ›´å¥½çš„è®¾è®¡æˆ–è€…æ›´åŠ ä¼˜é›…çš„å®ç°ï¼Œä¸å¦¨ä¹Ÿæ‹¿å‡ºæ¥åˆ†äº«ä¸€ä¸‹ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;ç”¨Flaskæ¡†æ¶å¼€å‘webåº”ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šåœ¨è§†å›¾å±‚å†™å¾ˆå¤šç¹ççš„ä»£ç æ¥æ ¡éªŒè¡¨å•çš„æ•°æ®ï¼ŒåŒæ—¶æŠŠæäº¤çš„æ•°æ®è½¬æ¢æˆä¸šåŠ¡éœ€è¦çš„æ ¼å¼, ç»“æœå°±æ˜¯è§†å›¾å±‚çš„ä»£ç åˆ°å¤„å¤¹æ‚ç€è¡¨å•éªŒè¯çš„é€»è¾‘ï¼Œæ˜¾å¾—é”™ç»¼å¤æ‚ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚æ³¨æ„æˆ‘æ‰€æŒ‡çš„è¡¨å•æ˜¯æ›´åŠ å¹¿ä¹‰çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬query stringæˆ–è€…é€šè¿‡è®¾ç½®Content-Typeä¸º&lt;code&gt;application/json&lt;/code&gt;ä¼ é€’çš„æ•°æ®ã€‚å…ˆæ¥çœ‹ä¸€ä¸ªæ ·ä¾‹:&lt;/p&gt;
    
    </summary>
    
      <category term="Programming" scheme="http://imiliya.com/categories/Programming/"/>
    
    
      <category term="Python" scheme="http://imiliya.com/tags/Python/"/>
    
      <category term="Flask" scheme="http://imiliya.com/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>An Introduction to Python C Extension Programming (Part2)</title>
    <link href="http://imiliya.com/2016/08/19/py-c-ext-part2/"/>
    <id>http://imiliya.com/2016/08/19/py-c-ext-part2/</id>
    <published>2016-08-18T17:06:53.000Z</published>
    <updated>2016-08-19T16:11:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>TL; DR.</p>
<h2 id="ä»€ä¹ˆæ˜¯Python-C-Extensionï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯Python-C-Extensionï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯Python C Extensionï¼Ÿ"></a>ä»€ä¹ˆæ˜¯Python C Extensionï¼Ÿ</h2><p>æ‰€è°“<a href="https://docs.python.org/3/extending/extending.html" target="_blank" rel="external">Python C Extension</a>ï¼Œ æ˜¯æŒ‡åœ¨CPythonå¹³å°ä¸Šé¢,éµå¾ªPython C Extension Interfaceå†™å‡ºæ¥çš„cä»£ç æ¨¡å—ï¼Œç»è¿‡ç¼–è¯‘åå¯ä»¥åœ¨Pythonä»£ç ä¸­ç›´æ¥importï¼Œç›¸å½“äºä¸€ä¸ªPython Moduleã€‚ é€šä¿—çš„è®²ï¼Œå°±æ˜¯ç”¨Cè¯­è¨€å®ç°ä¸€ä¸ªlibraryï¼Œç„¶åç»™è¿™ä¸ªlibraryæŠ«ä¸€ä¸ªPythonæ¨¡å—çš„çš®ï¼Œå¥½è®©Pythonç¨‹åºåƒimportå…¶ä»–æ™®é€šPythonæ¨¡å—ä¸€æ ·æ¥ä½¿ç”¨è¿™ä¸ªC library.</p>
<h2 id="ç®€å•å®ç°"><a href="#ç®€å•å®ç°" class="headerlink" title="ç®€å•å®ç°"></a>ç®€å•å®ç°</h2><p>æˆ‘ä»¬ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£çš„ä¾‹å­æ¥å†™ä¸€ä¸ªextension æ¨¡å—å§(å·ä¸ªæ‡’ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘å°±å½“å®˜æ–¹æ–‡æ¡£çš„æ¬è¿å·¥äº†)ã€‚</p>
<p>åˆ›å»º<code>main.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> spam</div><div class="line"></div><div class="line">status = spam.system(<span class="string">'ls -l'</span>)</div></pre></td></tr></table></figure>
<p>spamæ˜¯æˆ‘ä»¬å°†è¦å®ç°çš„Extensionæ¨¡å—, ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œç›´æ¥importå°±è¡Œäº†ã€‚</p>
<p>ç„¶åæˆ‘ä»¬æ¥å®ç°è¿™ä¸ªæ¨¡å—ã€‚</p>
<a id="more"></a>
<p>åˆ›å»º<code>spam.c</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Python.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> PyObject *SpamError;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> PyObject *<span class="title">spam_system</span><span class="params">(PyObject *self, PyObject *args)</span> </span>&#123;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *command;</div><div class="line">  <span class="keyword">int</span> sts;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!PyArg_ParseTuple(args, <span class="string">"s"</span>, &amp;command))</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">   sts = system(command);</div><div class="line">   <span class="keyword">if</span> (sts &lt; <span class="number">0</span>) &#123;</div><div class="line">    PyErr_SetString(SpamError, <span class="string">"System command failed"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> PyLong_FromLong(sts);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> PyMethodDef SpamMethods[] = &#123;</div><div class="line">    &#123;<span class="string">"system"</span>, spam_system, METH_VARARGS, <span class="string">"Execute a shell command."</span>&#125;,</div><div class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> PyModuleDef spammodule = &#123;</div><div class="line">    PyModuleDef_HEAD_INIT,</div><div class="line">    <span class="string">"spam"</span>,</div><div class="line">    <span class="string">"spam document"</span>,</div><div class="line">    <span class="number">-1</span>,</div><div class="line">    SpamMethods</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function">PyMODINIT_FUNC <span class="title">PyInit_spam</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    PyObject *m;</div><div class="line"></div><div class="line">    m = PyModule_Create(&amp;spammodule);</div><div class="line">    <span class="keyword">if</span> (m == <span class="literal">NULL</span>)</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    SpamError = PyErr_NewException(<span class="string">"spam.error"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</div><div class="line">    Py_INCREF(SpamError);</div><div class="line">    PyModule_AddObject(m, <span class="string">"error"</span>, SpamError);</div><div class="line">    <span class="keyword">return</span> m;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>WTF, éƒ½æ˜¯äº›ä»€ä¹ˆé¬¼ç©æ„å„¿?</p>
<p><code>#include &lt;Python.h&gt;</code> å¼•å…¥äº†Python C APIçš„headeræ–‡ä»¶ï¼Œè¿™æ ·åœ¨<code>spam.c</code> ä¸­å°±å¯ä»¥ä½¿ç”¨Python.hé‡Œé¢å®šä¹‰çš„ç»“æ„ï¼Œ å‡½æ•°å’Œå®äº†ï¼Œ<code>Python.h</code>æŠŠ<code>&lt;stdio.h&gt;, &lt;string.h&gt;, &lt;errno.h&gt;,&lt;stdlib.h&gt;</code>è¿™äº›æ ‡å‡†åº“çš„headeréƒ½å·²ç»includeäº†è¿›æ¥ã€‚ å¦‚æœå¯¹Python.hé‡Œé¢çš„ä¸œè¥¿æ„Ÿå…´è¶£, åœ¨ç»ˆç«¯è·‘ä¸€ä¸‹<code>python3-config --cflags</code>, å°±èƒ½æ‰¾åˆ°æ–‡ä»¶çš„ä½ç½®ã€‚</p>
<pre><code>python3-config --cflags
</code></pre><p>åœ¨è¿è¡Œç»“æœä¸­æ‰¾åˆ°headerçš„è·¯å¾„(Mac)ã€‚</p>
<pre><code>-I/usr/local/Cellar/python3/3.5.2_1/Frameworks/Python.framework/Versions/3.5/include/python3.5m
</code></pre><p>ç›´æ¥cdåˆ°<code>/usr/local/Cellar/python3/3.5.2_1/Frameworks/Python.framework/Versions/3.5/include/python3.5m</code>ç›®å½•å°±èƒ½æ‰¾åˆ°è¿™ä¸ªheaderæ–‡ä»¶, Pythonæºç çš„å…¶ä»–headeræ–‡ä»¶ä¹Ÿéƒ½åœ¨è¿™é‡Œäº†ã€‚</p>
<p><code>static PyObject *SpamError</code>å®šä¹‰äº†ä¸€ä¸ªSpamErrorå¯¹è±¡, æ ¹æ®åå­—å¯ä»¥çŒœåˆ°è¿™å°†æ˜¯ä¸€ä¸ªå¼‚å¸¸ç±»ã€‚Pythonçš„æ‰€æœ‰å¯¹è±¡å¯¹åº”çš„éƒ½æ˜¯ä¸€ä¸ª<code>PyObject</code>çš„ç»“æ„ï¼Œ ä½ å¯ä»¥åˆ°object.hå¤´æ–‡ä»¶é‡Œé¢çœ‹çœ‹PyObjectæ˜¯æ€ä¹ˆå®šä¹‰çš„ï¼Œä¸è¿‡åªèƒ½çœ‹å¾—ä¸€è„¸æ‡µé€¼å°±æ˜¯äº†ï¼Œå¦‚æœå¯¹Pythonæºç å¥½å¥‡ï¼Œå¢™è£‚æ¨èã€ŠPythonæºç å‰–æã€‹è¿™æœ¬ä¹¦ã€‚ .</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">static PyObject *spam_system(PyObject *self, PyObject *<span class="keyword">args</span>) &#123;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *command;</div><div class="line">  int <span class="keyword">sts</span>;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!PyArg_ParseTuple(<span class="keyword">args</span>, <span class="string">"s"</span>, &amp;command))</div><div class="line">    <span class="keyword">return</span> NULL;</div><div class="line">   <span class="keyword">sts</span> = system(command);</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">sts</span> &lt; 0) &#123;</div><div class="line">    PyErr_SetString(SpamError, <span class="string">"System command failed"</span>);</div><div class="line">    <span class="keyword">return</span> NULL;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> PyLong_FromLong(<span class="keyword">sts</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>spam_system</code>å®šä¹‰äº†ä¸€ä¸ªé™æ€å‡½æ•°ã€‚ <code>self</code>æŒ‡å‘çš„æ˜¯å½“å‰æ¨¡å—ï¼Œ<code>args</code>åˆ™æ˜¯Pythonè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ä¼ å…¥çš„å‚æ•°.<br><code>PyArg_ParseTuple</code>æŠŠ<code>args</code>è§£ææˆcå­—ç¬¦ä¸², å¹¶è®©commandæŒ‡å‘è¿™ä¸ªå­—ç¬¦ä¸²çš„åœ°å€ï¼Œ ç„¶åè°ƒç”¨stdçš„systemå‡½æ•°(é€šè¿‡includeå¼•å…¥çš„)ã€‚ stsä¿å­˜äº†ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼Œ<code>sts &lt; 0</code> è¯´æ˜è°ƒç”¨å¤±è´¥ï¼Œé€šè¿‡<code>PyErr_SetString</code> è®¾ç½®å¼‚å¸¸ä¿¡æ¯ï¼Œå¦åˆ™<code>PyLong_FromLong</code>å°†è¿”å›å€¼è½¬æ¢ä¸ºPython çš„intå¯¹è±¡.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> PyMethodDef SpamMethods[] = &#123;</div><div class="line">    &#123;<span class="string">"system"</span>, spam_system, METH_VARARGS, <span class="string">"Execute a shell command."</span>&#125;,</div><div class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>SpamMethodsæ˜¯æ¨¡å—çš„æˆå‘˜æ–¹æ³•åˆ—è¡¨ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæ•°ç»„, æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª<em>PyMethodDef</em>çš„ç»“æœè¡¨ç¤ºä¸€ä¸ªæ¨¡å—çš„ä¸€ä¸ªæˆå‘˜æ–¹æ³•. <code>system</code>æ˜¯æœ€åè¾“å‡ºçš„å˜é‡åï¼Œ spam_systemæ˜¯åˆšæ‰å®šä¹‰çš„å‡½æ•°ï¼Œ _METH<em>VARARGS</em>è¡¨ç¤ºPythonè°ƒç”¨è¿™ä¸ªå‡½æ•°æ˜¯ä¼ å‚çš„æ–¹å¼ã€‚ <code>&quot;Execute s shell command&quot;</code> æ˜¯å‡½æ•°çš„æ³¨é‡Šä¿¡æ¯. <code>{NULL, NULL, 0, NULL}</code> èµ·ä¸€ä¸ªå“¨å…µçš„ä½œç”¨ï¼Œè¿™æ ·æ¨¡å—éå†<em>SpamMethods</em>åˆ°è¿™é‡Œå°±çŸ¥é“æ‰€æœ‰æˆå‘˜éƒ½å·²ç»è¢«å®šä¹‰äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> PyModuleDef spammodule = &#123;</div><div class="line">    PyModuleDef_HEAD_INIT,</div><div class="line">    <span class="string">"spam"</span>,</div><div class="line">    <span class="string">"spam document"</span>,</div><div class="line">    <span class="number">-1</span>,</div><div class="line">    SpamMethods</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å®šä¹‰äº†å°†è¦è¾“å‡ºçš„æ¨¡å—å¯¹è±¡, è¿™æ˜¯ä¸€ä¸ª<code>PyModuleDef</code>ç»“æ„ï¼ŒspamMethodså¯¹åº”äº†ä¸Šé¢å®šä¹‰çš„æˆå‘˜æ•°ç»„ã€‚ æœ€åæˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰æ¨¡å—çš„åˆå§‹åŒ–æ–¹æ³•:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function">PyMODINIT_FUNC <span class="title">PyInit_spam</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    PyObject *m;</div><div class="line"></div><div class="line">    m = PyModule_Create(&amp;spammodule);</div><div class="line">    <span class="keyword">if</span> (m == <span class="literal">NULL</span>)</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    SpamError = PyErr_NewException(<span class="string">"spam.error"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</div><div class="line">    Py_INCREF(SpamError);</div><div class="line">    PyModule_AddObject(m, <span class="string">"error"</span>, SpamError);</div><div class="line">    <span class="keyword">return</span> m;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>import spam</code> çš„æ—¶å€™ï¼ŒPython C Extensionçš„æ¨¡å—æœºåˆ¶å°±ä¼šæ‰§è¡ŒPyInt_spamå‡½æ•°æ¥åˆ›å»ºå¹¶åˆå§‹åŒ–æ¨¡å—, åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¿˜ä¼šåˆ›å»ºSpamErrorç±»å¹¶æ·»åŠ åˆ°spamæ¨¡å—çš„æˆå‘˜å˜é‡ä¸­, Py_INCREFå¢åŠ ä¸€ä¸ªSpamErrorçš„å¼•ç”¨è®¡æ•°(åé¢ä¼šè®²åˆ°Python çš„reference counting).</p>
<p>è‡³æ­¤spamæ¨¡å—çš„å®ç°å°±ç®—å¤§åŠŸå‘Šæˆï¼Œ æˆ‘ä»¬éœ€è¦æŠŠä»–ç¼–è¯‘æˆå¯ä»¥ç›´æ¥importçš„æ¨¡å—. æ‰‹åŠ¨ç¼–è¯‘è®¾ç½®å„ç§å‚æ•°æ¯”è¾ƒéº»çƒ¦ï¼Œå¯ä»¥åˆ©ç”¨<code>distutils</code>é‡Œé¢çš„æ–¹æ³•æ¥æ„å»º.</p>
<p>åˆ›å»ºsetup.py</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from distutils.core <span class="keyword">import</span> <span class="built_in">setup</span>, Extension</div><div class="line"></div><div class="line"><span class="built_in">setup</span>(name=<span class="string">'sample'</span>, ext_modules=[</div><div class="line">    Extension(<span class="string">'spam'</span>, [<span class="string">'spam.c'</span>])</div><div class="line">])</div></pre></td></tr></table></figure>
<p>æ³¨æ„Extensionçš„<code>__init__</code>æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šäº†æ¨¡å—åä¸ºspamï¼Œ éœ€è¦å’Œæ¨¡å—åˆå§‹åŒ–PyInit_spamä¸­çš„spamä¿æŒä¸€è‡´ï¼Œ import spamçš„è¿è¡Œæ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ªå‚æ•°çš„åå­—ï¼Œå»è°ƒç”¨å¯¹åº”PyInit_nameçš„æ–¹æ³•ã€‚</p>
<p>è¿è¡Œ</p>
<pre><code>python3 setup.py build_ext --inplace
</code></pre><p>ä¼šæŠŠspam.cç¼–è¯‘æˆå¯¹åº”çš„dllæ¨¡å—ï¼Œ<code>inplace</code> é€‰é¡¹æŒ‡å®šäº†ç»“æœæ–‡ä»¶çš„ä½ç½®æ˜¯å½“å‰ç›®å½•.</p>
<p>è·‘ä¸€ä¸‹æˆ‘ä»¬çš„<code>main.py</code></p>
<pre><code>python3 main.py
</code></pre><p>ç»“æœä¼šåœ¨ç»ˆç«¯æ‰“å°å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚</p>
<p>å¦‚æœæƒ³å®‰è£…åˆ°site-packagesä¸‹é¢ï¼Œ è¿è¡Œ<code>python3 setup.py install</code>ï¼Œ ç„¶åå°±å¯ä»¥åœ¨å…¶ä»–é¡¹ç›®ä¹Ÿèƒ½ç›´æ¥import spamæ¨¡å—äº†ã€‚</p>
<p><em>Extension</em> ç±»çš„ <em>__init__</em> æ–¹æ³•è¿˜æ¥å—å¾ˆå¤šå…¶ä»–çš„å‚æ•°: <em>include_dirs</em> æŒ‡å®šåŒ…å«å¤´æ–‡ä»¶çš„è·¯å¾„ï¼Œ <em>define_macros</em> å®šä¹‰ä¸€äº›å®ï¼Œ<em>library_dirs</em> æŒ‡å®šåŠ¨æ€é“¾æ¥çš„ç›®å½•, ç›¸å½“äºgccçš„ <em>-L</em> é€‰é¡¹ï¼Œlibraries æŒ‡å®šé“¾æ¥çš„åº“ï¼Œç›¸å½“ä¸gccçš„ <em>-l</em> é€‰é¡¹ã€‚è¿˜æœ‰å…¶ä»–ä¸€äº›å‚æ•°è¯»è€…è¯·è‡ªè¡Œå‚è€ƒ<a href="https://docs.python.org/3.5/distutils/apiref.html#distutils.core.Extension" target="_blank" rel="external">distutils</a>ã€‚</p>
<h2 id="é”™è¯¯å’Œå¼‚å¸¸-Errors-and-Exception"><a href="#é”™è¯¯å’Œå¼‚å¸¸-Errors-and-Exception" class="headerlink" title="é”™è¯¯å’Œå¼‚å¸¸(Errors and Exception)"></a>é”™è¯¯å’Œå¼‚å¸¸(Errors and Exception)</h2><p>Pythonè§£é‡Šå™¨æœ‰ä¸€ä¸ªä¸æˆæ–‡çš„è§„å®šï¼Œ å½“å‡½æ•°å¤±è´¥çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªå¼‚å¸¸ä¿¡æ¯ï¼Œå¹¶ä¸”è¿”å›é”™è¯¯å€¼ï¼Œå¼‚å¸¸ä¿¡æ¯ä¿å­˜åœ¨è§£é‡Šå™¨çš„ä¸€ä¸ªé™æ€å…¨å±€å˜é‡ä¸­ã€‚å¦‚æœè¿™ä¸ªå˜é‡çš„å€¼ä¸ºNULL(ç©ºæŒ‡é’ˆ)ï¼Œè¯´æ˜æ²¡æœ‰å¼‚å¸¸å‘ç”Ÿã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸¤ä¸ªå…¨å±€å˜é‡ï¼Œä¸€ä¸ªä¿å­˜äº†å¼‚å¸¸ä¿¡æ¯å¯¹åº”çš„æè¿°ï¼Œå¦ä¸€ä¸ªä¿å­˜äº†å‘ç”Ÿå¼‚å¸¸æ—¶çš„æ•´ä¸ªè°ƒç”¨å †æ ˆ, å®ƒä»¬å¯¹åº”äº†sys.exc_info()ç»“æœçš„ä¸‰ä¸ªå…ƒç´ ã€‚</p>
<p>å‰é¢ç”¨åˆ°çš„PyErr_SetString()æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„å¼‚å¸¸ç±»å¯¹è±¡,ç¬¬äºŒä¸ªå‚æ•°æ˜¯å…³è”çš„å¼‚å¸¸ä¿¡æ¯æè¿°ã€‚ <em>PyErr_SetString(SpamError, â€œSystem command failedâ€)</em> è®¾ç½®äº†å…¨å±€çš„å¼‚å¸¸ä¿¡æ¯,Pythonè§£é‡Šå™¨å‘ç°è¿™ä¸ªå¼‚å¸¸ä¿¡æ¯çš„æ—¶å€™ï¼Œä¼šè·³è½¬åˆ°å¼‚å¸¸å¤„ç†æµç¨‹(å¦‚æœæƒ³äº†è§£Pythonè§£é‡Šå™¨æ˜¯æ€ä¹ˆè¿ä½œçš„, å¼‚å¸¸æœºåˆ¶åˆæ˜¯å¦‚ä½•å®ç°çš„ï¼Œå†æ¬¡æ¨èã€ŠPythonæºç å‰–æã€‹è¿™æœ¬ä¹¦)ã€‚</p>
<h2 id="ä¸€ç‚¹é¢˜å¤–è¯â€”â€”å¼•ç”¨è®¡æ•°-Reference-Counts"><a href="#ä¸€ç‚¹é¢˜å¤–è¯â€”â€”å¼•ç”¨è®¡æ•°-Reference-Counts" class="headerlink" title="ä¸€ç‚¹é¢˜å¤–è¯â€”â€”å¼•ç”¨è®¡æ•°(Reference Counts)"></a>ä¸€ç‚¹é¢˜å¤–è¯â€”â€”å¼•ç”¨è®¡æ•°(Reference Counts)</h2><p>Cå’ŒC++è¦æ±‚ç¨‹åºå‘˜è´Ÿè´£åŠ¨æ€çš„åˆ†é…å’Œå›æ”¶å †ä¸Šçš„å†…å­˜ï¼ŒCè¯­è¨€æä¾›äº†malloc()å’Œfree()å‡½æ•°(C++å¯¹åº”æœ‰newå’Œdeleteæ“ä½œç¬¦)ã€‚</p>
<p>æ¯ä¸€ä¸ªmalloc()åˆ†é…çš„å†…å­˜èµ„æºï¼Œ æœ€ç»ˆéƒ½éœ€è¦é€šè¿‡è°ƒç”¨free()æ¥å›æ”¶, å¦‚æœå¿˜è®°äº†freeï¼Œ è¢«åˆ†é…çš„å†…å­˜èµ„æºç›´åˆ°è¿›ç¨‹é€€å‡ºéƒ½æ— æ³•é‡æ–°åˆ©ç”¨ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„å†…å­˜æ³„æ¼(memory leak)ã€‚å¦‚æœç»§ç»­ä½¿ç”¨free()è¿‡çš„å†…å­˜ï¼Œ å¾ˆæœ‰å¯èƒ½å’Œä»¥åé€šè¿‡malloc()é‡æ–°åˆ†é…çš„å†…å­˜èµ„æºå†²çªï¼Œä¼šé€ æˆåŒå¼•ç”¨æ²¡æœ‰åˆå§‹åŒ–çš„æŒ‡é’ˆä¸€æ ·çš„ç»“æœï¼Œcore dumps, é”™è¯¯çš„ç»“æœï¼Œè¿›ç¨‹è«åå´©æºƒä¹‹ç±»ã€‚</p>
<p>å¸¸è§çš„å†…å­˜æ³„éœ²éƒ½æ˜¯ç¨‹åºå¿˜è®°è°ƒç”¨freeé€ æˆçš„ï¼Œæ¯”å¦‚é”™è¯¯å¤„ç†çš„é€»è¾‘ä¸­ç›´æ¥returnå´æ²¡æœ‰freeä¹‹å‰åˆ†é…çš„å†…å­˜ï¼Œå°¤å…¶æ˜¯ä»£ç é‡æ¯”è¾ƒå¤§çš„æ—¶å€™å¾ˆå®¹æ˜“å‡ºç°ã€‚å¦‚æœæŸä¸ªæœ‰å†…å­˜æ³„éœ²çš„å‡½æ•°è¢«å¤§é‡çš„è°ƒç”¨ï¼Œé‚£ä¹ˆæ¯æ¬¡è°ƒç”¨éƒ½ä¼šé€ æˆä¸€å®šçš„å†…å­˜æ³„æ¼, å¦‚æœåªæ˜¯çŸ­æš‚è¿è¡Œçš„è¿›ç¨‹ï¼Œéšç€è¿›ç¨‹ç»“æŸï¼Œè¿™äº›èµ„æºéƒ½ä¼šè¢«æ“ä½œç³»ç»Ÿå›æ”¶ã€‚ä½†æ˜¯å¦‚æœæ˜¯é•¿æ—¶é—´è¿è¡Œçš„è¿›ç¨‹ï¼ˆæ¯”å¦‚ä¸€ä¸ªåå°daemon)ï¼Œæ²¡æœ‰å›æ”¶çš„å†…å­˜èµ„æºä¼šéšç€ç¨‹åºè¿è¡Œæ—¶é—´çš„å¢åŠ è€Œå¢åŠ ï¼Œæœ€ç»ˆæŠŠç³»ç»Ÿèµ„æºè€—å°½ï¼Œç¨‹åºå´©æºƒã€‚ æ‰€ä»¥é€šè¿‡ä¸€ä¸ªå¥½çš„ç¼–ç è§„èŒƒé¿å…å†…å­˜æ³„éœ²å°±æ˜¾å¾—ååˆ†é‡è¦ã€‚</p>
<p>Pythonå¤§é‡çš„ä½¿ç”¨äº†mallocå’Œfreeæ¥ç®¡ç†å†…å­˜ï¼Œå°±å¿…é¡»æœ‰ä¸€ä¸ªå¥½çš„ç­–ç•¥æ¥é¿å…ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚Pythonä½¿ç”¨çš„ä¸»è¦æ–¹æ³•æ˜¯ <em>reference counting</em>(å¼•ç”¨è®¡æ•°) . ç®€å•åœ°è®²ï¼Œ æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“æœ‰æ–°çš„å¼•ç”¨ï¼Œè®¡æ•°å™¨çš„å€¼+1, å¦‚æœå¼•ç”¨è¢«åˆ é™¤ï¼Œè®¡æ•°å™¨çš„å€¼å°±-1ï¼Œå½“è®¡æ•°å™¨çš„å€¼å‡åˆ°0ï¼Œè¿™ä¸ªå¯¹è±¡å ç”¨çš„å†…å­˜å°±å¯ä»¥å›æ”¶äº†ã€‚</p>
<p>å¼•ç”¨è®¡æ•°ä¸èƒ½è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå¾ªç¯å¼•ç”¨æ˜¯æŒ‡å­˜åœ¨äº’ç›¸å¼•ç”¨çš„å¯¹è±¡ï¼Œå¼•ç”¨è®¡æ•°æ°¸è¿œä¸å¯èƒ½å‡åˆ°0, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç²—æš´çš„ä¾‹å­:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> gc</div><div class="line">gc.disable() <span class="comment"># å…³é—­gcåŠŸèƒ½</span></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">  a = [<span class="number">1</span>] * <span class="number">1000000</span></div><div class="line">  b = [<span class="number">1</span>] * <span class="number">1000000</span></div><div class="line">  a.append(b)</div><div class="line">  b.append(a)</div><div class="line">  <span class="keyword">del</span> a</div><div class="line">  <span class="keyword">del</span> b</div></pre></td></tr></table></figure>
<p><strong>å‹æƒ…æç¤º</strong>  åƒä¸‡ä¸è¦æ‰‹è´±è¿è¡Œä¸Šé¢çš„ä»£ç !! å¯¹äºä¸å¬åŠå‘Šçš„å°æœ‹å‹ï¼Œå¦‚æœé€ æˆæ— æ³•æŒ½å›çš„åæœæœ¬äººè¡¨ç¤ºä¸è´Ÿä»»ä½•è´£ä»»ã€‚</p>
<p><code>del a</code>å’Œ<code>del b</code>åï¼Œæˆ‘ä»¬çš„ç¨‹åºå·²ç»æ²¡æœ‰å¯¹è¿™ä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨äº†ï¼Œä½†æ˜¯bå’Œaè¿˜æ˜¯äº’ç›¸å¼•ç”¨äº†å¯¹è±¡ï¼Œä»–ä»¬çš„refcountéƒ½æ˜¯1ï¼Œé‚£ä¹ˆå¼•ç”¨è®¡æ•°æœºåˆ¶å°±æ°¸è¿œä¸ä¼šå»å›æ”¶aå’Œbçš„å†…å­˜, æ¯ä¸ªWhileå¾ªç¯éƒ½ä¼šå‡ºç°ä¸€æ¬¡å¾ªç¯å¼•ç”¨ï¼Œè¿™ä¸ªç¨‹åºä¼šè¿…é€Ÿèš•é£Ÿæ‰ä½ çš„å†…å­˜ã€‚</p>
<p> Pythoné€šè¿‡ä¸€ä¸ªå«åš<a href="https://en.wikipedia.org/wiki/Cycle_detection" target="_blank" rel="external">cycle detector</a>çš„æŠ€æœ¯è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œ<a href="https://docs.python.org/3/library/gc.html#module-gc" target="_blank" rel="external">gc</a>æ¨¡å—ç”šè‡³æä¾›äº†collectæ–¹æ³•è®©ç¨‹åºå‘˜è‡ªå·±æ‰‹åŠ¨å¤„ç†å¾ªç¯å¼•ç”¨ã€‚å¦‚æœä½ èƒ½ä¿è¯ä½ çš„Pythonä»£ç ä¸ä¼šå‡ºç°å¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡<code>--without-cycle-gc</code>è¿™ä¸ªå¯åŠ¨é€‰é¡¹å…³æ‰è‡ªåŠ¨å›æ”¶çš„åŠŸèƒ½, ä¸è¿‡ä¸å»ºè®®è¿™ä¹ˆåšï¼ŒWhy bothering your self if Python could handle it for you?</p>
<p>ä¹Ÿè®¸ä½ å¯ä»¥è¯•è¯•æŠŠä¸Šé¢çš„<code>gc.disable()</code>è¿™ä¸€è¡Œæ³¨é‡Šæ‰å†è¿è¡Œè¿™æ®µä»£ç ã€‚  Please be very very careful!</p>
<p>Pythoné€šè¿‡å¼•ç”¨è®¡æ•°å’Œåƒåœ¾å›æ”¶ï¼Œå®ç°äº†å†…å­˜çš„è‡ªåŠ¨ç®¡ç†ï¼ŒæŠŠPythonç¨‹åºå‘˜ä»æ‰‹åŠ¨å†…å­˜ç®¡ç†çš„è´Ÿæ‹…é‡è§£è„±äº†å‡ºæ¥ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹Pythonçš„å¼•ç”¨è®¡æ•°æ˜¯å…·ä½“æ˜¯æ€ä¹ˆç©çš„ã€‚</p>
<h3 id="Reference-Counting-in-Python"><a href="#Reference-Counting-in-Python" class="headerlink" title="Reference Counting in Python"></a>Reference Counting in Python</h3><p>Note:  ä¸‹é¢æåˆ°<code>ref</code>, <code>reference</code>, <code>å¼•ç”¨</code>è¿™ä¸‰ä¸ªè¯æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p>
<p>Pythoné€šè¿‡ä¸¤ä¸ªå® Py_INCREF(x) and Py_DECREF(x)æ¥æ“ä½œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚é—®é¢˜æ˜¯è¿™ä¸¤ä¸ªå®éƒ½éœ€è¦åœ¨ä»€ä¹ˆæ—¶å€™å»è°ƒç”¨å‘¢ï¼Ÿ</p>
<p>Pythonçš„APIæ–‡æ¡£ä¸­ä»‹ç»äº†å‡ ä¸ªæœ¯è¯­ã€‚</p>
<ul>
<li><p><strong>own</strong>: ä¸€ä¸ªå¯¹è±¡æœ‰å¾ˆå¤šä¸ªreferenceï¼Œæ¯ä¸ªreferenceå¯¹åº”ä¼šæœ‰ä¸€ä¸ªownerï¼Œ ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±æ˜¯ownerçš„ä¸ªæ•°. ownerå¯ä»¥é€šè¿‡ä¼ é€’ï¼Œ ä¿å­˜ï¼Œæˆ–è€…ç›´æ¥Py_DECREF()æ¥æ”¾å¼ƒå¯¹è¿™ä¸ªå¯¹è±¡çš„referenceã€‚</p>
</li>
<li><p><strong>borrow</strong>:  å¹¶ä¸ownä¸€ä¸ªreferenceï¼Œä¸ä¼šå¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå› æ­¤ä¹Ÿä¸éœ€è¦è°ƒç”¨Py_DECREF, å¦‚æœå¯¹ä¸€ä¸ªborrowçš„referenceè°ƒç”¨äº†Py_INCREFï¼Œ å°±æŠŠä»–å˜æˆäº†ä¸€ä¸ªownerã€‚</p>
</li>
</ul>
<p>å½“ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ä½œä¸ºå‚æ•°ä¼ å…¥å‡½æ•°æˆ–è€…ä½œä¸ºå‡½æ•°çš„è¿”å›ç»“æœæ—¶ï¼Œ æ ¹æ®å‡½æ•°çš„æ¥å£å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å¯¹åº”ownershipæœ‰æ²¡æœ‰è¢«è½¬ç§»ã€‚</p>
<p>å¤§å¤šæ•°è¿”å›ä¸€ä¸ªå¼•ç”¨çš„å‡½æ•°ä¼šæŠŠownershipäº¤ç»™è°ƒç”¨è€…ï¼Œ ä¸€èˆ¬çš„å¦‚æœå‡½æ•°åˆ›å»ºäº†æ–°çš„å¯¹è±¡å¹¶è¿”å›å¯¹è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œæ¯”å¦‚PyLong_FromLong(), Py_BuildValue, é‚£ä¹ˆè¿™ä¸ªå¼•ç”¨çš„ownershipè½¬ç»™äº†è°ƒç”¨è€…ã€‚ä¾‹å¤–çš„æ˜¯ PyTuple_GetItem(), PyList_GetItem(), PyDict_GetItem(), and PyDict_GetItemString()è¿™äº›å‡½æ•°ï¼Œåªæ˜¯è¿”å›ä¸€ä¸ªborrowedå¼•ç”¨ã€‚</p>
<p>å½“å¯¹è±¡å¼•ç”¨ä½œä¸ºå‚æ•°ä¼ å…¥å‡½æ•°çš„æ—¶å€™ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å‡½æ•°éƒ½æ˜¯borrowäº†è¿™ä¸ªreferenceï¼Œå¹¶ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœå‡½æ•°éœ€è¦å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œéœ€è¦æ˜¾ç¤ºè°ƒç”¨Py_INCREFã€‚ ä¸è¿‡ä¹Ÿæœ‰ä¾‹å¤–ï¼Œ PyTuple_SetItem() and PyList_SetItem()è¿™ä¸¤ä¸ªå‡½æ•°å°±æ¥ç®¡äº†å¼•ç”¨æˆä¸ºownerã€‚</p>
<p>æ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆæŠ½è±¡(åæ­£æˆ‘åˆšå¼€å§‹çš„æ—¶å€™å°±æ˜¯ä¸€è„¸æ‡µé€¼), ä¸ºä»€ä¹ˆä¸€ä¼šå„¿è¦borrowä¸€ä¼šå„¿è¦ownçš„â€¦ä¸‹é¢ä¸¾å‡ ä¸ªä¾‹å­æ¥åˆ†æä¸€ä¸‹ä½ åº”è¯¥å°±èƒ½ç¨å¾®æ˜ç™½ä¸€ç‚¹äº†.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">bug</span><span class="params">(PyObject *<span class="built_in">list</span>)</span></div><div class="line">&#123;</div><div class="line">    PyObject *item = PyList_GetItem(<span class="built_in">list</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">    PyList_SetItem(<span class="built_in">list</span>, <span class="number">1</span>, PyLong_FromLong(<span class="number">0L</span>));</div><div class="line">    PyObject_Print(item, <span class="built_in">stdout</span>, <span class="number">0</span>); <span class="comment">/* BUG! */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>PyList_GetItemè¿”å›äº†listç¬¬ä¸€ä¸ªå…ƒç´ çš„å¼•ç”¨ï¼Œæ ¹æ®<a href="https://docs.python.org/3.5/c-api/list.html#c.PyList_GetItem" target="_blank" rel="external">PyList_GetItem</a>çš„æ–‡æ¡£æˆ‘ä»¬çŸ¥é“è¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªborrowedå¼•ç”¨, ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šå¢åŠ list[0]è¿™ä¸ªå…ƒç´ çš„å¼•ç”¨è®¡æ•°ï¼ˆæˆ‘ä»¬å‡è®¾ç°åœ¨list[0],list[1]çš„refcountéƒ½æ˜¯1), æ¥ä¸‹æ¥æˆ‘ä»¬è®¾ç½®list[1]å…ƒç´ çš„å€¼ä¸º0(æ–°åˆ›å»ºçš„intå¯¹è±¡)ï¼Œè€ŒåŸå…ˆçš„list[1]å¼•ç”¨çš„å¯¹è±¡çš„refcountå°±ä¼šå‡1å˜æˆ0ï¼Œè¿™ä¸ªæ—¶å€™ åŸå…ˆlist[1]å¯¹è±¡çš„<a href="https://docs.python.org/3/reference/datamodel.html#object.__del__" target="_blank" rel="external"><code>__del__</code></a>å°±ä¼šè¢«è°ƒç”¨ï¼Œè€Œ<code>__del__</code>æ–¹æ³•å¯ä»¥ç›´æ¥è®¿é—®list[0]çš„å…ƒç´ ï¼Œå¦‚æœåœ¨é‡Œé¢è°ƒç”¨del list[0], list[0]å…ƒç´ çš„å¼•ç”¨è®¡æ•°ä¹Ÿå‡ä¸º0äº†ï¼ŒPyObject_Printå‡½æ•°å°±ä¼šè®¿é—®åˆ°ä¸€ä¸ªå·²ç»è¢«å›æ”¶çš„å†…å­˜åœ°å€, ä¸‹é¢æ˜¯æ¨¡æ‹Ÿè¿™ä¸ªåœºæ™¯çš„pythonä»£ç ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">list0 = object()</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obj</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></div><div class="line">      <span class="keyword">del</span> list0</div><div class="line"></div><div class="line">list1 = Obj()</div><div class="line">l = [list0, list1]</div></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥å¦‚æœæ˜¯borrowä¸€ä¸ªå¼•ç”¨çš„è¯ï¼Œå¿…é¡»ä¿è¯åœ¨ä½¿ç”¨è¿™ä¸ªå¼•ç”¨çš„è¿‡ç¨‹ä¸­è¿™ä¸ªå¼•ç”¨å¯¹è±¡çš„refcountä¸ä¼šå‡ä¸º0, ä¿®æ”¹å‰é¢çš„Cä»£ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">no_bug</span><span class="params">(PyObject *<span class="built_in">list</span>)</span></div><div class="line">&#123;</div><div class="line">    PyObject *item = PyList_GetItem(<span class="built_in">list</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">    Py_INCREF(item);</div><div class="line">    PyList_SetItem(<span class="built_in">list</span>, <span class="number">1</span>, PyLong_FromLong(<span class="number">0L</span>));</div><div class="line">    PyObject_Print(item, <span class="built_in">stdout</span>, <span class="number">0</span>);</div><div class="line">    Py_DECREF(item);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨PyList_SetItemä¹‹å‰å¢åŠ itemå¯¹è±¡å¼•ç”¨è®¡æ•°ï¼Œä¿è¯äº†PyObject_Printè®¿é—®åˆ°çš„itemçš„æœ‰æ•ˆæ€§ã€‚</p>
<p>æˆ–è€…ä½¿ç”¨<a href="https://docs.python.org/3.5/c-api/sequence.html#c.PySequence_GetItem" target="_blank" rel="external">PySequence_GetItem</a>æ–¹æ³•ï¼ŒæŸ¥çœ‹æ–‡æ¡£æˆ‘ä»¬å‘ç°è¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªowner referenceï¼Œå¢åŠ äº†ä¸€ä¸ªå¯¹å¯¹åº”å…ƒç´ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">no_bug</span><span class="params">(PyObject *<span class="built_in">list</span>)</span></div><div class="line">&#123;</div><div class="line">    PyObject *item = PySequence_GetItem(<span class="built_in">list</span>, <span class="number">0</span>);</div><div class="line">    PyList_SetItem(<span class="built_in">list</span>, <span class="number">1</span>, PyLong_FromLong(<span class="number">0L</span>));</div><div class="line">    PyObject_Print(item, <span class="built_in">stdout</span>, <span class="number">0</span>);</div><div class="line">    Py_DECREF(item);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åªéœ€è¦ç”¨å®Œä¹‹åè°ƒç”¨Py_DECREFæ¥å»æ‰åˆšæ‰å¢åŠ çš„å¼•ç”¨è®¡æ•°, ä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯PySequence_GetItemæ—¢ç„¶è¿”å›çš„æ˜¯ä¸€ä¸ªowner, é‚£ä¹ˆç”¨è¿™ä¸ªå®ƒçš„ç›®çš„å°±æ˜¯è¦é•¿æ—¶é—´å ç”¨çš„ï¼Œè€Œä¸æ˜¯åƒä¸Šé¢è¿™æ ·åªæ˜¯printä¸€ä¸‹, è¿™ä¸ªåœ°æ–¹ç”¨PySequence_GetItemå…¶å®å·²ç»å¤±å»æœ¬æ„äº†, ç”¨PyList_GetItemæš‚æ—¶borrowä¸€ä¸‹æ˜¯æ›´åŠ æ­£ç¡®çš„é€‰æ‹©ã€‚</p>
<p>æ‰€ä»¥ä½ å‘ç°borrowå’Œownçš„åŒºåˆ«äº†ä¹ˆ? borrowè¿‡æ¥referenceçš„ä¸ä¼šå ç”¨ä¸€ä¸ªè®¡æ•°ï¼Œåœ¨ä½¿ç”¨borrowçš„å¼•ç”¨è¿‡ç¨‹ä¸­å¿…é¡»è¦è‡ªå·±ä¿è¯å¼•ç”¨æœ‰æ•ˆï¼Œå¦‚æœå¯ä»¥ä¿è¯ä¸­é—´æ²¡æœ‰æ“ä½œå¯èƒ½å‡å°‘è¿™ä¸ªå¼•ç”¨è®¡æ•°çš„è¯ï¼Œæˆ‘ä»¬ç”šè‡³çœå»äº†INCå’ŒDECå¼•ç”¨çš„çƒ¦æ¼ï¼Œæ‰€è°“borrowå°±æ˜¯æˆ‘å€Ÿè¿‡æ¥ç”¨ä¸€ä¸‹ï¼Œç­‰ä¸‹è‚¯å®šä¼šè¿˜ä½ çš„ã€‚è¿™ä¸ªæ¯”å–»å…¶å®æœ‰ä¸€ç‚¹ä¸æ°å½“çš„åœ°æ–¹ï¼Œå› ä¸ºborrowçš„referenceå…¶å®ä¹Ÿè¢«å€Ÿå‡ºæ–¹å ç€çš„ï¼Œæ¯”å¦‚ä¸Šé¢çš„listä¹Ÿè¿˜æ˜¯å¯ä»¥è®¿é—®itemå¯¹è±¡ï¼Œå€Ÿçš„è¿‡ç¨‹ä¸­å€Ÿç”¨æ–¹ç”šè‡³è¿˜è¦æ‹…å¿ƒè¢«å€Ÿèµ°çš„ä¸œè¥¿è¢«å·²ç»è¢«å¤„ç†æ‰çš„å¯èƒ½ï¼ˆPyList_SetItemï¼‰ï¼Œ è¿™å…¶å®å°±ä¸å«å€Ÿäº†å§ï¼Œè¿˜ä¸å¦‚è¯´æ˜¯æš‚æ—¶shareç»™ä½ ä¸€ä¼šå„¿ï¼Œè™½ç„¶ä½ ä¹Ÿèƒ½ç”¨ï¼Œä½†æ˜¯åˆ«äººé—®èµ·æ¥ä½ å¾—è¯´è¿™ä¸ªä¸œè¥¿ä½ å¹¶æ²¡æœ‰æ‰€æœ‰æƒ, è€Œä¸”shareç»™ä½ çš„äººå¿ƒæƒ…ä¸å¥½æŠŠä¸œè¥¿ç»™å–äº†ä½ å°±ç”¨ä¸äº†äº†ï¼Œè¿™ä¸ªæ—¶å€™Py_INCREFå°±å¥½åƒåœ¨è¯´ä½ å…ˆåˆ«å–å•Šï¼Œæˆ‘è¿˜æ²¡ç”¨å®Œå‘¢ï¼ŒPy_DECREFåˆ™æ˜¯è¯´æˆ‘ç°åœ¨å·²ç»ä¸ç”¨äº†ï¼Œä½ çˆ±æ€ä¹ˆç©æ€ä¹ˆç©ã€‚ownå°±ä¸ä¸€æ ·äº†ï¼Œå¦‚æœæˆ‘ä»¬ä¸¤ä¸ªéƒ½ownäº†ä¸€ä¸ªä¸œè¥¿ï¼Œé‚£ä¹ˆå…‰ä½ è¯´å–è¿˜ä¸æˆï¼Œä½ åªèƒ½è¯´è‡ªå·±ä¸è¦äº†ï¼ˆåƒdel list0)é‚£æ ·ï¼Œä½†æ˜¯æˆ‘è¿˜å ç€ä¸€ä»½å‘¢ï¼ŒPy_DECREFåˆ™æ˜¯è¯´ç°åœ¨æˆ‘ä¹Ÿä¸æƒ³è¦äº†â€”â€”å–‚ï¼Œé‚£ä¸ªæ¡åƒåœ¾çš„(itemçš„ <code>__del__</code> æ–¹æ³•)ï¼Œä½ æ¥æ‹¿èµ°å§ã€‚ ä¸çŸ¥é“è¿™æ ·è¡¨è¿°æ¸…ä¸æ¸…æ¥šã€‚</p>
<p>å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼ŒPythonçš„GILä¿è¯äº†è¿™ä¸ªå‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­,å› æ­¤æˆ‘ä»¬ä¸å¿…æ‹…å¿ƒè¢«borrowçš„å¼•ç”¨itemåœ¨å¦ä¸€ä¸ªçº¿ç¨‹è¢«å›æ”¶äº†ï¼ˆæ¯”å¦‚åœ¨å¦ä¸€ä¸ªthreadè°ƒç”¨äº†PyList_SetItemï¼Œé‡Œé¢åˆåšäº†å‡å°‘itemå¼•ç”¨è®¡æ•°çš„äº‹æƒ…ï¼ˆè®ºGILçš„é‡è¦æ€§). ä½†æ˜¯pythonæä¾›äº†Py_BEGIN_ALLOW_THREADSè¿™ä¸ªå®æ¥æš‚æ—¶è§£é™¤å…¨å±€é”ï¼Œçœ‹çœ‹ä¸‹é¢çš„è¿™ä¸ªä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">bug</span><span class="params">(PyObject *<span class="built_in">list</span>)</span></div><div class="line">&#123;</div><div class="line">    PyObject *item = PyList_GetItem(<span class="built_in">list</span>, <span class="number">0</span>);</div><div class="line">    Py_BEGIN_ALLOW_THREADS</div><div class="line">    ...some blocking I/O call...</div><div class="line">    <span class="function">Py_END_ALLOW_THREADS</span></div><div class="line">    <span class="title">PyObject_Print</span><span class="params">(item, <span class="built_in">stdout</span>, <span class="number">0</span>)</span>; <span class="comment">/* BUG! */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Py_BEGIN_ALLOW_THREADSå’ŒPy_END_ALLOW_THREADSä¹‹é—´ï¼ŒGILè¢«é‡Šæ”¾äº†ï¼Œäºæ˜¯itemå°±æœ‰å¯èƒ½åœ¨å¦ä¸€ä¸ªçº¿ç¨‹è¢«å›æ”¶æ‰ï¼Œåé¢åœ¨æ‰§è¡Œ PyObject_Printå°±å¯èƒ½äº§ç”Ÿæ„æƒ³ä¸åˆ°çš„bug!</p>
<p>ç”¨borrowè¿˜æ˜¯ownå…¶å®å¹¶æ²¡æœ‰æ˜ç¡®çš„è§„å®šï¼Œå–å†³äºé‚£ä¸ªæ¨¡å‹åœ¨ç‰¹å®šåœºæ™¯ä¸‹ä½¿ç”¨æ›´åŠ æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®˜æ–¹æ–‡æ¡£çŸ¥é“æŸä¸ªPython C APIçš„å‡½æ•°å…·ä½“ç”¨çš„borrowè¿˜æ˜¯ownã€‚</p>
<p>è®²äº†è¿™ä¹ˆå¤šå¼•ç”¨è®¡æ•°çš„ä¸œè¥¿å¥½åƒå·²ç»åé¢˜äº†, çœ‹å¾—å‡ºæ¥åœ¨C Extensioné‡Œé¢å¯¹å¼•ç”¨è®¡æ•°çš„å¤„ç†ä¹Ÿæ˜¯ä¸€ä»¶æ¯”è¾ƒtrickyçš„äº‹æƒ…ã€‚å¦‚æœä½ å¯¹è¿™å—å¾ˆæ„Ÿå…´è¶£ï¼Œç›´æ¥é˜…è¯»<a href="https://docs.python.org/3/extending/extending.html" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©, è¿™ç¯‡æ–‡ç« <a href="http://edcjones.tripod.com/refcount.html" target="_blank" rel="external">http://edcjones.tripod.com/refcount.html</a>åˆ™åšäº†ä¸€å®šçš„è§£é‡Šå’Œè¡¥å……ã€‚ please keep reading patiently!</p>
<p>å¦‚æœä½ å¯¹ <em>borrow</em>ï¼Œ<em>own</em> è¿™ä¸€å—å¾ˆæ„Ÿå…´è¶£ ,éš”å£æœ‰ä¸€é—¨å«åš<a href="https://doc.rust-lang.org/book/ownership.html" target="_blank" rel="external">Rust</a>çš„è¯­è¨€å€¼å¾—å°è¯•, å¯ä»¥çœ‹çœ‹å®ƒçš„ <em>ownership system</em> æ˜¯æ€ä¹ˆç©çš„ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç®€å•çš„è®², å®ç°ä¸€ä¸ªC Extensionæ¨¡å—è¦åšå¥½ä¸‰ä»¶äº‹æƒ…</p>
<ol>
<li>æ»¡è¶³C Extensionæ¥å£çš„è§„èŒƒ</li>
<li>å¤„ç†å¥½æ•°æ®åœ¨Pythonå’ŒCä¹‹é—´çš„è½¬åŒ–</li>
<li>ç”¨Cè¯­è¨€å®ç°å…·ä½“çš„åŠŸèƒ½ï¼ˆæˆ–è€…è°ƒç”¨å·²æœ‰çš„åº“)</li>
</ol>
<p>å†å›é¡¾ä¸€ä¸‹æˆ‘ä»¬çš„spam.cæ–‡ä»¶ï¼Œæ‰€æœ‰å˜é‡çš„å®šä¹‰éƒ½æ˜¯staticçš„ï¼Œè¡¨ç¤ºè¿™äº›å˜é‡çš„ä½œç”¨åŸŸä»…é™äº<code>spam.c</code>ï¼Œèµ·åˆ°äº†é™åˆ¶ä½œç”¨åŸŸçš„ä½œç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SpamError = PyErr_NewException(<span class="string">"spam.error"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</div><div class="line">Py_INCREF(SpamError);</div><div class="line">PyModule_AddObject(m, <span class="string">"error"</span>, SpamError);</div></pre></td></tr></table></figure>
<p>å› ä¸º<a href="https://docs.python.org/3.5/c-api/module.html#c.PyModule_AddObject" target="_blank" rel="external">PyModule_AddObject</a>ä¸ä¼šå¢åŠ SpamErrorçš„å¼•ç”¨è®¡æ•°,å®˜æ–¹çš„è¯å«steal the reference, å¦‚æœæˆ‘ä»¬ä¸æ‰‹åŠ¨INCä¸€ä¸‹ï¼Œé‚£ä¹ˆä»¥ååˆ é™¤äº†m.errorè¿™ä¸ªå±æ€§çš„è¯ï¼ŒSpamErrorçš„è®¡æ•°å°±å˜0ï¼Œå¯¹åº”çš„å†…å­˜è¢«å›æ”¶ï¼Œå¦‚æœåé¢åˆæŠ›å‡ºäº†è¿™ä¸ªå¼‚å¸¸æ•‘æŠ¤å‡ºç°æ„æƒ³ä¸åˆ°çš„é”™è¯¯ã€‚</p>
<p>PyArg_ParseTupleçš„formatå‚æ•°æ ¼å¼è¯·å‚è€ƒ<a href="https://docs.python.org/3/c-api/arg.html" target="_blank" rel="external">PyArg_ParseTuple</a>, ä¸ä¹‹å¯¹åº”çš„è¿˜æœ‰<code>Py_BuildValue</code> å‡½æ•°ï¼Œ ç”¨æ¥æ„é€ Pythonå¯¹è±¡.</p>
<p><a href="https://github.com/moonshadow/way-to-python-ninja/tree/master/python-c-ext/impl-python-c-ext" target="_blank" rel="external">ç›¸å…³ä»£ç </a></p>
<p>Anyway, æ‰‹åŠ¨å®ç°ä¸€ä¸ªPython C Extensionå§‹ç»ˆæ˜¯ä¸€ä»¶å¾ˆéº»çƒ¦çš„äº‹(è¿˜è¦äº†è§£Pythonçš„å¼•ç”¨è®¡æ•°æ˜¯æ€ä¹ˆç©çš„)ã€‚å¦‚æœåªæ˜¯ç®€å•ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨<code>ctypes</code>å°±èƒ½ç›´æ¥æå®šï¼Œ é‚£ä¸“å¿ƒå†™å¥½Cä»£ç ï¼Œç„¶åç›´æ¥è®©Pythonåƒç”¨æ™®é€šæ¨¡å—ä¸€æ ·æŠŠå®ƒç”¨èµ·æ¥å²‚ä¸æ˜¯æ›´åŠ æ–¹ä¾¿ï¼Ÿ ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°±æ¥çœ‹çœ‹ä¸€ä¸ªå«åšCFFIçš„ç¬¬ä¸‰æ–¹åº“åˆæ˜¯æ€ä¹ˆå®ç°åœ¨Pythonä¸­è°ƒç”¨Cè¯­è¨€åº“çš„å§ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;TL; DR.&lt;/p&gt;
&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯Python-C-Extensionï¼Ÿ&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯Python-C-Extensionï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯Python C Extensionï¼Ÿ&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯Python C Extensionï¼Ÿ&lt;/h2&gt;&lt;p&gt;æ‰€è°“&lt;a href=&quot;https://docs.python.org/3/extending/extending.html&quot;&gt;Python C Extension&lt;/a&gt;ï¼Œ æ˜¯æŒ‡åœ¨CPythonå¹³å°ä¸Šé¢,éµå¾ªPython C Extension Interfaceå†™å‡ºæ¥çš„cä»£ç æ¨¡å—ï¼Œç»è¿‡ç¼–è¯‘åå¯ä»¥åœ¨Pythonä»£ç ä¸­ç›´æ¥importï¼Œç›¸å½“äºä¸€ä¸ªPython Moduleã€‚ é€šä¿—çš„è®²ï¼Œå°±æ˜¯ç”¨Cè¯­è¨€å®ç°ä¸€ä¸ªlibraryï¼Œç„¶åç»™è¿™ä¸ªlibraryæŠ«ä¸€ä¸ªPythonæ¨¡å—çš„çš®ï¼Œå¥½è®©Pythonç¨‹åºåƒimportå…¶ä»–æ™®é€šPythonæ¨¡å—ä¸€æ ·æ¥ä½¿ç”¨è¿™ä¸ªC library.&lt;/p&gt;
&lt;h2 id=&quot;ç®€å•å®ç°&quot;&gt;&lt;a href=&quot;#ç®€å•å®ç°&quot; class=&quot;headerlink&quot; title=&quot;ç®€å•å®ç°&quot;&gt;&lt;/a&gt;ç®€å•å®ç°&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£çš„ä¾‹å­æ¥å†™ä¸€ä¸ªextension æ¨¡å—å§(å·ä¸ªæ‡’ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘å°±å½“å®˜æ–¹æ–‡æ¡£çš„æ¬è¿å·¥äº†)ã€‚&lt;/p&gt;
&lt;p&gt;åˆ›å»º&lt;code&gt;main.py&lt;/code&gt;:&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; spam&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;status = spam.system(&lt;span class=&quot;string&quot;&gt;&#39;ls -l&#39;&lt;/span&gt;)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;spamæ˜¯æˆ‘ä»¬å°†è¦å®ç°çš„Extensionæ¨¡å—, ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œç›´æ¥importå°±è¡Œäº†ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åæˆ‘ä»¬æ¥å®ç°è¿™ä¸ªæ¨¡å—ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Programming" scheme="http://imiliya.com/categories/Programming/"/>
    
    
      <category term="Python" scheme="http://imiliya.com/tags/Python/"/>
    
      <category term="C" scheme="http://imiliya.com/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>An Introduction to Python C Extension Programming (Part1)</title>
    <link href="http://imiliya.com/2016/08/16/py-c-ext-part1/"/>
    <id>http://imiliya.com/2016/08/16/py-c-ext-part1/</id>
    <published>2016-08-16T00:45:36.000Z</published>
    <updated>2016-08-18T18:05:27.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å†™åšå®¢çš„åŠ¨æœº"><a href="#å†™åšå®¢çš„åŠ¨æœº" class="headerlink" title="å†™åšå®¢çš„åŠ¨æœº"></a>å†™åšå®¢çš„åŠ¨æœº</h2><p>å½“äº†è¿™ä¹ˆä¹…çš„ç¨‹åºå‘˜ï¼Œä¸­é—´æœ‰å¥½å‡ æ¬¡ä¹Ÿæƒ³è¿‡å¼€ä¸ªåšå®¢å†™ç‚¹ä»€ä¹ˆã€‚å¯æ˜¯ä¸€æ¥è§‰å¾—è‡ªå·±å¤ªèœï¼Œå†åˆå®åœ¨è¿‡äºæ€ æƒ°ï¼Œè®¡åˆ’å°±æç½®ä¸€æ—(ä¹°äº†ä¸ªåŸŸåèººäº†ä¸€å¹´ğŸ˜‚)ã€‚ ç„¶è€Œä¸€ç›´ä»¥æ¥çœ‹äº†å„è·¯å¤§ä¾ çš„åšå®¢ï¼Œå·å·å­¦åˆ°ä¸å°‘ä¸œè¥¿, æ„Ÿè§‰å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆèœäº†ï¼Œä¹Ÿè§‰ç€åº”è¯¥æŠŠè‡ªå·±çš„ä¸€äº›æƒ³æ³•å’Œè§è§£åˆ†äº«å‡ºå»ï¼Œå›é¦ˆç¤¾ä¼š, è€Œä¸æ˜¯åœ¨è‡ªå·±çš„è„‘å­é‡Œé¢æ†‹ç€ï¼Œ å³ä½¿è¢«æ‰“è„¸ä¹Ÿç®—æ˜¯åˆå­¦åˆ°äº†å˜›, ä½•ä¹è€Œä¸ä¸ºã€‚</p>
<p>åœ¨ä¸‹ä¸€ä»‹Pythonç¨‹åºå‘˜, è€Œä¸”æ˜¯<em>çœŸã®Pythonç²‰</em>ï¼Œé‚£å°±ä»Pythonå†™èµ·å§, ä¹Ÿæ¯”è¾ƒå¾—å¿ƒåº”æ‰‹ä¸€ç‚¹ã€‚ç°ä»Šå¸‚é¢ä¸Šå……æ–¥å„ç§Pythonæ•™ç¨‹(Pythonä¹ŸçœŸæ˜¯å¤ªç®€å•æ˜“ä¸Šæ‰‹äº†), æˆ‘å°±ä¸å»å‡‘è¿™ä¸ªçƒ­é—¹ä¹Ÿè®²äº›PythonåŸºç¡€æˆ–è€…<em>tips</em>ä»€ä¹ˆçš„äº†ã€‚å°†è¦è®²åˆ°çš„å†…å®¹éƒ½æ˜¯é¢å‘è‡³å°‘ä¸­çº§çš„Pythonç¨‹åºå‘˜çš„. æ‰€ä»¥è¯»è€…æœ€å¥½æ˜¯å…·å¤‡ä¸€å®šçš„Pythonæ°´å¹³ï¼Œå¦‚æœæ˜¯åˆšå…¥é—¨çš„å°æœ‹å‹, è‡³å°‘å…ˆä¹°ä¸¤æœ¬å…¥é—¨æ•™ç¨‹æ’¸ä¸€éå†æ¥å§ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ä¸é€ã€‚</p>
<p>æš‚å®šçš„ç³»åˆ—æœ‰</p>
<ol>
<li>Python C Extension</li>
<li>Profile</li>
<li>Debugging</li>
<li>Python2 or Python3</li>
<li>Unicode</li>
<li>AsyncIO</li>
<li>Modules</li>
<li>Logging</li>
</ol>
<a id="more"></a>
<h2 id="First-of-first-Python-C-Extension"><a href="#First-of-first-Python-C-Extension" class="headerlink" title="First of first (Python C Extension)"></a>First of first (Python C Extension)</h2><p>ä¸çŸ¥é“å¤§å®¶è§‰å¾—Pythonæœ€ç¥ç§˜çš„åœ°æ–¹åœ¨å“ªé‡Œã€‚åæ­£åœ¨æˆ‘çš„ç»éªŒçœ‹æ¥ï¼Œæœ€æä¸æ¸…æ‰¯ä¸æ˜çš„åœ°æ–¹å°±æ˜¯æ‰€è°“çš„Python C Extension Moduleäº†ã€‚ctypesï¼Œ cffiï¼Œ swigï¼Œ cython, numbaè¿™äº›åè¯ï¼Œå¬ä¸Šå»å°±è§‰å¾—å¥½å¯æ€•, æƒ³æœä¸ªåƒæ ·å­çš„ä»‹ç»æ–‡ç« å‡ºæ¥éƒ½éš¾, ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£å§æœ‰æ„Ÿè§‰æœ‰ç‚¹overwhelming. æ‰€ä»¥æˆ‘å¸Œæœ›é€šè¿‡C Extensionè¿™ä¸ªç³»åˆ—çš„æ–‡ç« ï¼ŒæŠŠè¿™äº›ç©æ„å„¿ä¸€ä¸ªä¸€ä¸ªéƒ½æ¢ç´¢ä¸€ä¸‹ã€‚ æœ¬äººCè¯­è¨€æ°´å¹³æœ‰é™ï¼Œå¦‚æœæœ‰èƒ¡è¯´å…«é“çš„åœ°æ–¹ï¼Œ æ¬¢è¿æŒ‡æ­£ï¼Œå¤§å®¶ä¸€èµ·å­¦ä¹ è¿›æ­¥ğŸ˜€ã€‚ ä»¥åæ‰€æœ‰æ–‡ç« åªé’ˆå¯¹Python3ï¼Œå…³äº<em>Python2 or Python3</em>, ä»¥åä¹Ÿä¼šæ‰¾æœºä¼šè®¨è®ºä¸€ä¸‹, å¦‚æœæœ‰å¿…è¦è”ç³»Python2çš„ç›¸å…³çŸ¥è¯†æˆ‘ä¼šä¸“é—¨æŒ‡å‡º, æ–‡ä¸­æ‰€æœ‰æ¶‰åŠåˆ°ç¼–è¯‘cä»£ç çš„åœ°æ–¹éƒ½å‡è®¾è¯»è€…ä½¿ç”¨çš„æ˜¯ç±»unixçš„æ“ä½œç³»ç»Ÿ(åŸå› æ˜¯æˆ‘å¯¹windowsçš„ç”Ÿæ€ç³»ç»Ÿå®åœ¨ä¸€æ— æ‰€çŸ¥)ã€‚</p>
<h2 id="why-C"><a href="#why-C" class="headerlink" title="why C?"></a>why C?</h2><p>å¥½å§ï¼Œæˆ‘ä»¬ç”¨Pythonæ˜¯å› ä¸ºå®ƒå¾ˆé«˜çš„æŠ½è±¡å±‚æ¬¡ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿…é€Ÿçš„æ„å»ºåº”ç”¨ï¼Œä¸è®ºæ˜¯å†™ä¸€ä¸ªç®€å•çš„ä»»åŠ¡è„šæœ¬è¿˜æ˜¯æ­ä¸€ä¸ªå°å‹ç½‘ç«™ï¼ŒPythonéƒ½æ˜¯ä¸Šä½³é€‰æ‹©ã€‚ç„¶è€Œä¸–ä¸Šæ²¡æœ‰å…è´¹åˆé¤ï¼Œå¼€å‘æ•ˆç‡çš„ä»£ä»·æ˜¯ç‰ºç‰²äº†è½¯ä»¶æ€§èƒ½ï¼Œä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹è¿™éƒ½ä¸æ˜¯äº‹ï¼Œæ¯”å¦‚Pythonæ„å»ºçš„web appæ€§èƒ½ç“¶é¢ˆå¤§å¤šéƒ½åœ¨IOï¼Œè¿™æ˜¯æ²¡æ³•åœ¨ä»£ç å±‚é¢ä¼˜åŒ–çš„, å¯ä»¥é€šè¿‡æ”¹å˜IOæ¨¡å‹æˆ–è€…æ‰©å®¹æœåŠ¡å™¨æ¥è§£å†³ã€‚è€Œä¸”ä¸€èˆ¬çš„Pythonç¨‹åºå‘˜ä¹ æƒ¯äº†Pythonçš„ç®€ä»‹ä¼˜é›…ï¼Œå¯èƒ½å¯¹æ€§èƒ½ä»€ä¹ˆçš„æ²¡ä»€ä¹ˆæ¦‚å¿µã€‚ä¸è¿‡å¤œè·¯èµ°å¤šäº†æ€»ä¼šæ’é¬¼ï¼Œå¹³å¸¸æ²¡æœ‰æ„è¯†ï¼ŒçœŸæ­£æ€§èƒ½å‡ºç°é—®é¢˜éœ€è¦ä¼˜åŒ–çš„æ—¶å€™åªèƒ½æ˜¯ä¸€è„¸æ‡µé€¼ã€‚å¦‚æœèƒ½å¤Ÿå…·å¤‡ä¸€å®šçš„æ€§èƒ½æ„è¯†ï¼Œåœ¨éœ€è¦çš„æ—¶å€™çŸ¥é“æœ‰å“ªäº›åŠæ³•å¯ä»¥é€‰æ‹©å’Œå°è¯•ï¼Œé‚£ä¹ˆè‡³å°‘æ˜¯èµ°åœ¨äº†æ­£ç¡®çš„é“è·¯ä¸Šã€‚æ€§èƒ½Profileä¹Ÿæ˜¯ä¸€ä¸ªå¤§çš„è¯é¢˜ï¼Œä»¥åå†å±•å¼€ã€‚</p>
<p>å­¦ä¹ C Extension Programmingä¹Ÿèƒ½åŠ æ·±å¯¹Pythonè¯­è¨€æœ¬èº«çš„ç†è§£ï¼Œ å¯¹äºå†™å‡ºæ›´é«˜è´¨é‡çš„Pythonä»£ç ä¹Ÿæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚ æ‰€ä»¥åºŸè¯ä¸å¤šè¯´ï¼Œè¿›å…¥ç¬¬ä¸€ä¸ªè¯é¢˜ï¼Œå¦‚ä½•åœ¨Pythonä»£ç é‡Œé¢è°ƒç”¨Cå‡½æ•°.</p>
<h2 id="How-to-call-C-function-in-Python-code"><a href="#How-to-call-C-function-in-Python-code" class="headerlink" title="How to call C function in Python code?"></a>How to call C function in Python code?</h2><p>pythonæ ‡å‡†åº“æä¾›äº†<a href="https://docs.python.org/3.5/library/ctypes.html#module-ctypes" target="_blank" rel="external"><strong>ctypes</strong></a>æ¨¡å—, å¯ä»¥å¸®åŠ©æˆ‘ä»¬æŠŠDLLæˆ–è€…shared libraries(å…±äº«åº“)ä¸­çš„å‡½æ•°å°è£…æˆå¯ä»¥ç›´æ¥è°ƒç”¨çš„Pythonå‡½æ•°ã€‚å¦‚æœå‘ç°éœ€è¦çš„æŸä¸ªå·¥å…·å·²ç»æœ‰Cè¯­è¨€çš„library, æˆ‘ä»¬å°±ä¸éœ€è¦é‡æ–°ç”¨Pythonå®ç°ç›¸åŒåŠŸèƒ½çš„æ¨¡å—ï¼Œ æ—¢ä¿è¯äº†æ•ˆç‡è¿˜èƒ½çœå»æ€§èƒ½çš„çƒ¦æ¼ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­:</p>
<p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªCæ–‡ä»¶<code>utils.c</code>, å®šä¹‰factorialå’Œswapä¸¤ä¸ªå‡½æ•°.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">factorial</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (x &lt;= <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> factorial(x<span class="number">-1</span>) * x;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> *a, <span class="keyword">int</span> *b)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> temp = *a;</div><div class="line">  *a = *b;</div><div class="line">  *b = temp;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶<code>utils.o</code>(æˆ‘ç”¨çš„æ˜¯Macä¸‹é¢çš„LLVMç¼–è¯‘å™¨ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -c -Wall -Werror utils.c</div></pre></td></tr></table></figure>
<p>å†æŠŠåˆšç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶è½¬åŒ–æˆåŠ¨æ€é“¾æ¥åº“.</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">gcc</span> <span class="selector-tag">-shared</span> <span class="selector-tag">-o</span> <span class="selector-tag">libutils</span><span class="selector-class">.so</span> <span class="selector-tag">utils</span><span class="selector-class">.o</span></div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨<em>Python</em>ä»£ç ä¸­è°ƒç”¨åˆšæ‰åœ¨<code>utils.c</code>ä¸­å®šä¹‰çš„ä¸¤ä¸ªå‡½æ•°. ä¸‹é¢ç¤ºä¾‹å¦‚ä½•ç”¨<em>ctypes</em>æ¥æ“ä½œï¼Œåˆ›å»ºæ–‡ä»¶<code>main.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ctypes</div><div class="line"></div><div class="line"></div><div class="line">utils = ctypes.cdll.LoadLibrary(<span class="string">'./libutils.so'</span>)</div><div class="line"></div><div class="line">factorial = utils.factorial</div><div class="line">factorial.argtypes = (ctypes.c_int,)</div><div class="line">factorial.restype = ctypes.c_int</div><div class="line"></div><div class="line">_swap  = utils.swap</div><div class="line">_swap.argtypes = (ctypes.POINTER(ctypes.c_int), ctypes.POINTER(ctypes.c_int))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">swap</span><span class="params">(x, y)</span>:</span></div><div class="line">    a = ctypes.c_int(x)</div><div class="line">    b = ctypes.c_int(y)</div><div class="line">    _swap(a, b)</div><div class="line">    <span class="keyword">return</span> a.value, b.value</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    print(<span class="string">'factorial of 4 is %s !'</span> % factorial(<span class="number">4</span>))</div><div class="line">    print(<span class="string">'factorial of 5 is %s !'</span> % factorial(<span class="number">5</span>))</div><div class="line"></div><div class="line">    x, y = <span class="number">10</span>, <span class="number">20</span></div><div class="line">    print(<span class="string">'x is %s and y is %s'</span> % (x, y))</div><div class="line">    x, y = swap(x, y)</div><div class="line">    print(<span class="string">'after swap'</span>)</div><div class="line">    print(<span class="string">'x is %s and y is %s'</span> % (x, y))</div></pre></td></tr></table></figure>
<p><code>utils = ctypes.cdll.LoadLibrary(&#39;./libutils.so&#39;)</code> è½½å…¥äº†å·²ç»ç¼–è¯‘å¥½çš„<code>libutils.so</code>, factorialå’Œswapä¸¤ä¸ªå‡½æ•°å˜æˆäº†æ¨¡å—çš„locals.ï¼ˆå¦‚æœä¸æ˜¯è‡ªå·±ç¼–è¯‘çš„æ¨¡å—è€Œæ˜¯æƒ³ç”¨ç³»ç»Ÿçš„Cè¯­è¨€å…±äº«åº“ï¼Œå‚è€ƒ<code>cypes.utils</code>çš„<code>find_library</code>æ–¹æ³•ï¼Œè·¯å¾„é€šå¸¸éƒ½æ˜¯<code>/usr/lib</code> å’Œ <code>/usr/local/lib</code>ï¼Œ linuxæ“ä½œç³»ç»Ÿé»˜è®¤éƒ½æ˜¯<em>libxxx.so</em>çš„æ ¼å¼ï¼Œ è€Œos xåˆ™æ˜¯<em>libxxx.dylib</em>)</p>
<p>å¯¹äº<code>factorial</code>å‡½æ•°ï¼Œåªéœ€è¦æŠŠpythonçš„intå¯¹è±¡è½¬æ¢æˆå¯¹åº”çš„ctypeç±»å‹å†ä¼ å…¥factorialå‡½æ•°ï¼Œ åŒæ—¶éœ€è¦å®šä¹‰è¿”å›çš„ç»“æœç±»å‹ï¼ŒæŠŠfactorialå‡½æ•°è¿”å›çš„intè½¬æ¢æˆPythonçš„intå¯¹è±¡</p>
<p><code>swap</code>å‡½æ•°ç¨å¾®éº»çƒ¦ä¸€ç‚¹ï¼Œå› ä¸ºPythonä¸èƒ½ç›´æ¥è®¿é—®æŒ‡é’ˆï¼Œæ‰€ä»¥éœ€è¦æŠŠå·²æœ‰çš„cå‡½æ•°ç¨å¾®åšä¸ªå°è£…ï¼Œ ä¸è¿‡æ€è·¯ä¸€æ ·å°±æ˜¯äº†.</p>
<p>æœ€åéªŒè¯ä¸€ä¸‹ç»“æœã€‚<br>è¿è¡Œ</p>
<pre><code>python3 main.py
</code></pre><p>ç»ˆç«¯è¾“å‡º</p>
<pre><code>factorial of 4 is 24 !
factorial of 5 is 120 !
x is 10 and y is 20
after swap
x is 20 and y is 10
</code></pre><p>Perfect! ç®€å•çš„å‡ ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†åœ¨Pythonä¸­è°ƒç”¨cå‡½æ•°.</p>
<p>é¡ºä¾¿æˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹Cè¯­è¨€å®ç°çš„factorialå’ŒPythonç‰ˆæœ¬çš„æ€§èƒ½,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> ctypes</div><div class="line"><span class="keyword">from</span> timeit <span class="keyword">import</span> timeit</div><div class="line"></div><div class="line"></div><div class="line">utils = ctypes.cdll.LoadLibrary(<span class="string">'./libutils.so'</span>)</div><div class="line"></div><div class="line">factorial = utils.factorial</div><div class="line">factorial.argtypes = (ctypes.c_int,)</div><div class="line">factorial.restype = ctypes.c_int</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">py_factorial</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">assert</span> isinstance(n, int)</div><div class="line">    <span class="keyword">if</span> n &lt;= <span class="number">0</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    <span class="keyword">return</span> py_factorial(n<span class="number">-1</span>) * n</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    number = <span class="number">100000</span></div><div class="line">    print(<span class="string">'Python ç‰ˆæœ¬100000æ¬¡çš„factorial(10)æ—¶é—´'</span>)</div><div class="line">    print(timeit(<span class="string">'py_factorial(10)'</span>, number=number, globals=globals()))</div><div class="line">    print(<span class="string">'C ç‰ˆæœ¬100000æ¬¡çš„factorial(10)æ—¶é—´'</span>)</div><div class="line">    print(timeit(<span class="string">'factorial(10)'</span>, number=number, globals=globals()))</div></pre></td></tr></table></figure>
<p>ä¿å­˜åˆ°<code>benchmark.py</code></p>
<p>åœ¨æˆ‘çš„æœºå™¨ä¸Šè¿è¡Œçš„ç»“æœæ˜¯</p>
<pre><code>Python ç‰ˆæœ¬100000æ¬¡çš„factorial(10)æ—¶é—´
0.3275668309943285
C ç‰ˆæœ¬100000æ¬¡çš„factorial(10)æ—¶é—´
0.07990392099600285
</code></pre><p>å¤§æ¦‚4å€çš„æ ·å­, very nice!</p>
<p>ç¬¬ä¸€ä¸ªä¾‹å­å°±åˆ°è¿™é‡Œäº†ï¼Œctypesæ‰“å¼€äº†Pythonè°ƒç”¨cä»£ç åº“çš„å¤§é—¨ã€‚ ç„¶è€Œå¾ˆå¤šæ—¶å€™å¹¶æ²¡æœ‰ç°æˆçš„cåº“ç»™æˆ‘ä»¬è°ƒï¼Œ é‚£ä¹ˆå°±éœ€è¦è‡ªå·±å†™Pythonçš„C Extensionäº†ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬å…ˆç ”ç©¶ä¸€ä¸‹å¦‚ä½•è£¸å†™ä¸€ä¸ªPythonçš„C extensionæ¨¡å—å§.</p>
<p>ä¸Šé¢ç¤ºä¾‹çš„ä»£ç å·²ç»æ”¾åˆ°<a href="https://github.com/moonshadow/way-to-python-ninja" target="_blank" rel="external"><strong>github</strong></a>ä¸Šé¢äº†ï¼Œå¯ä»¥æ‹‰ä¸‹æ¥å‚ç…§<a href="https://docs.python.org/3.5/library/ctypes.html#module-ctypes" target="_blank" rel="external"><strong>ctypes</strong></a>çš„æ–‡æ¡£è‡ªå·±ç©ç©, å¦‚æœä½ æœ‰æ›´å¥½çš„sampleæˆ–è€…å»ºè®®æ¬¢è¿ä¸€èµ·äº¤æµ.</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å†™åšå®¢çš„åŠ¨æœº&quot;&gt;&lt;a href=&quot;#å†™åšå®¢çš„åŠ¨æœº&quot; class=&quot;headerlink&quot; title=&quot;å†™åšå®¢çš„åŠ¨æœº&quot;&gt;&lt;/a&gt;å†™åšå®¢çš„åŠ¨æœº&lt;/h2&gt;&lt;p&gt;å½“äº†è¿™ä¹ˆä¹…çš„ç¨‹åºå‘˜ï¼Œä¸­é—´æœ‰å¥½å‡ æ¬¡ä¹Ÿæƒ³è¿‡å¼€ä¸ªåšå®¢å†™ç‚¹ä»€ä¹ˆã€‚å¯æ˜¯ä¸€æ¥è§‰å¾—è‡ªå·±å¤ªèœï¼Œå†åˆå®åœ¨è¿‡äºæ€ æƒ°ï¼Œè®¡åˆ’å°±æç½®ä¸€æ—(ä¹°äº†ä¸ªåŸŸåèººäº†ä¸€å¹´ğŸ˜‚)ã€‚ ç„¶è€Œä¸€ç›´ä»¥æ¥çœ‹äº†å„è·¯å¤§ä¾ çš„åšå®¢ï¼Œå·å·å­¦åˆ°ä¸å°‘ä¸œè¥¿, æ„Ÿè§‰å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆèœäº†ï¼Œä¹Ÿè§‰ç€åº”è¯¥æŠŠè‡ªå·±çš„ä¸€äº›æƒ³æ³•å’Œè§è§£åˆ†äº«å‡ºå»ï¼Œå›é¦ˆç¤¾ä¼š, è€Œä¸æ˜¯åœ¨è‡ªå·±çš„è„‘å­é‡Œé¢æ†‹ç€ï¼Œ å³ä½¿è¢«æ‰“è„¸ä¹Ÿç®—æ˜¯åˆå­¦åˆ°äº†å˜›, ä½•ä¹è€Œä¸ä¸ºã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä¸‹ä¸€ä»‹Pythonç¨‹åºå‘˜, è€Œä¸”æ˜¯&lt;em&gt;çœŸã®Pythonç²‰&lt;/em&gt;ï¼Œé‚£å°±ä»Pythonå†™èµ·å§, ä¹Ÿæ¯”è¾ƒå¾—å¿ƒåº”æ‰‹ä¸€ç‚¹ã€‚ç°ä»Šå¸‚é¢ä¸Šå……æ–¥å„ç§Pythonæ•™ç¨‹(Pythonä¹ŸçœŸæ˜¯å¤ªç®€å•æ˜“ä¸Šæ‰‹äº†), æˆ‘å°±ä¸å»å‡‘è¿™ä¸ªçƒ­é—¹ä¹Ÿè®²äº›PythonåŸºç¡€æˆ–è€…&lt;em&gt;tips&lt;/em&gt;ä»€ä¹ˆçš„äº†ã€‚å°†è¦è®²åˆ°çš„å†…å®¹éƒ½æ˜¯é¢å‘è‡³å°‘ä¸­çº§çš„Pythonç¨‹åºå‘˜çš„. æ‰€ä»¥è¯»è€…æœ€å¥½æ˜¯å…·å¤‡ä¸€å®šçš„Pythonæ°´å¹³ï¼Œå¦‚æœæ˜¯åˆšå…¥é—¨çš„å°æœ‹å‹, è‡³å°‘å…ˆä¹°ä¸¤æœ¬å…¥é—¨æ•™ç¨‹æ’¸ä¸€éå†æ¥å§ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ä¸é€ã€‚&lt;/p&gt;
&lt;p&gt;æš‚å®šçš„ç³»åˆ—æœ‰&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Python C Extension&lt;/li&gt;
&lt;li&gt;Profile&lt;/li&gt;
&lt;li&gt;Debugging&lt;/li&gt;
&lt;li&gt;Python2 or Python3&lt;/li&gt;
&lt;li&gt;Unicode&lt;/li&gt;
&lt;li&gt;AsyncIO&lt;/li&gt;
&lt;li&gt;Modules&lt;/li&gt;
&lt;li&gt;Logging&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="Programming" scheme="http://imiliya.com/categories/Programming/"/>
    
    
      <category term="Python" scheme="http://imiliya.com/tags/Python/"/>
    
      <category term="C" scheme="http://imiliya.com/tags/C/"/>
    
  </entry>
  
</feed>
